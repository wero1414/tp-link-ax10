!function(b){b.su.moduleManager.define("dashboard",{deps:["speedTest","navigatorController","main"],services:["ajax","timer","moduleLoader","moduleManager"],models:["statusAll","internetSpeedModel","priorityEnable"],stores:["connectedClientsStore","usbStorageStore","timePeriodStore"],views:["dashboardView"],listeners:{ev_on_launch:function(e,t,n,a,i,o,s){this.unRegisterAutoSaveData([i.connectedClientsStore]),t.initPerformance(),t.initSpeedtest(),t.initClients(),s.timer.setInterval(t,function(){a.statusAll.load()},2e3,!0),a.priorityEnable.getOnOff()}},init:function(o,e,s,r,l,d){this.configViews({id:"dashboardView",items:[{id:"internet-conn-note","notes-title":b.su.CHAR.NETWORK_MAP.TRY_FOLLOW,items:[{text:b.su.CHAR.NETWORK_MAP.TRY_1},{text:b.su.CHAR.NETWORK_MAP.TRY_2},{text:b.su.CHAR.NETWORK_MAP.TRY_3},{text:b.su.CHAR.NETWORK_MAP.TRY_4}]},{id:"connected-clients-grid",configs:{columns:[{dataIndex:"deviceName",cls:"m-hide l-hide xl-hide label-empty"},{dataIndex:"deviceType",cls:"m-hide l-hide xl-hide label-empty",renderer:function(e,t){var n="",a="",i="";switch(e=e.toLowerCase()){case"pc":n="icon-pc";break;case"phone":n="icon-phone";break;case"pad":n="icon-pad";break;case"other":n="icon-pc";break;default:n="icon-"+e}return a=a+'<div class="device-type-container widget-container">'+('<span class="icon '+n+' ">'+(i=t.isGaming?'<span class="gaming-tag"></span>':i)+"</span>"),null!=t.enableInternet&&(a+='<span class="text">'+(t.enableInternet?"":b.su.CHAR.NETWORK_MAP.INTERNET_PAUSED)+"</span>"),a=(a=(a+="</div>")+'<div class="device-info-container widget-container">'+('<div class="mac">'+t.mac+"</div>"))+('<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div>")+"</div>"}},{text:b.su.CHAR.DASHBOARD.TYPE,width:"16%",dataIndex:"deviceType",cls:"s-hide",renderer:function(e,t){var n="",a="",i="";switch(e=e.toLowerCase()){case"pc":n="icon-pc";break;case"phone":n="icon-phone";break;case"pad":n="icon-pad";break;case"other":n="icon-pc";break;default:n="icon-"+e}return a=a+'<div class="device-type-container widget-container">'+('<span class="icon '+n+' ">'+(i=t.isGaming?'<span class="gaming-tag"></span>':i)+"</span>"),null!=t.enableInternet&&(a+='<span class="text">'+(t.enableInternet?"":b.su.CHAR.NETWORK_MAP.INTERNET_PAUSED)+"</span>"),a+="</div>"}},{text:b.su.CHAR.DASHBOARD.INFORMATION,dataIndex:"deviceName",width:"25%",cls:"s-hide",renderer:function(e,t){var n,a="";return a="object"===b.type(t)?(a=(a+='<div class="device-info-container widget-container">')+'<div class="name" title="'+(n=t.deviceName)+'">'+n+'</div><div class="mac">'+t.mac+"</div>")+'<div class="ip">'+("0.0.0.0"==t.ip?"":t.ip)+"</div></div>":a}},{text:b.su.CHAR.DASHBOARD.REAL_TIME_RATE,dataIndex:"downloadSpeed",renderer:function(e,t){var n,a="",i=function(e){var t=(e=parseInt(e,10))/1024<1?(0!==e&&(e=(e/1024).toFixed(2)),b.su.CHAR.DASHBOARD.KBPS):e/1024/1024<1?(e/1024<1e3?e=(e/1024).toFixed(1):e/=1024,b.su.CHAR.DASHBOARD.KBPS):(e=(e/1024/1024).toFixed(1),b.su.CHAR.DASHBOARD.MBPS);return{speed:e,unit:t}};return"object"===b.type(t)&&(n=i(t.downloadSpeed),a=(a=(a=(a=(a+='<div class="speed-upload-container widget-container">')+'<span class="icon"></span><span class="text">'+(t=i(t.uploadSpeed)).speed+"</span>")+'<span class="unit">'+t.unit+'</span></div><div class="speed-download-container widget-container">')+'<span class="icon"></span><span class="text">'+n.speed+"</span>")+'<span class="unit">'+n.unit+"</span></div>"),a}},{text:b.su.CHAR.DASHBOARD.DEVICE_PRIORITY,dataIndex:"enablePriority",xtype:"customWidget",cls:"status connected-clients-grid-priority-td",widgetName:"switch",settings:{trueValue:!0,falseValue:!1}},{text:b.su.CHAR.DASHBOARD.TIMING,dataIndex:"timePeriod",xtype:"customWidget",width:90,cls:"s-2-col",widgetName:"combobox",settings:{noneSelectedText:"",items:r.timePeriodStore.getData()},renderer:function(e,t){return!t.enablePriority&&"---"}}]}}]}),this.control({"#speed-test-mini-panel":{click:function(){b("#speed-test-mini-panel").toggleClass("selected").siblings(".mini-panel").removeClass("selected"),b("#internet-block").toggle(b("#speed-test-mini-panel").hasClass("selected")),b("#performance-panel").hide(),b("#usb-panel").hide(),e.dashboardView.internetSpeedUsage.resize()}},"#performance-mini-panel":{click:function(){b("#performance-mini-panel").toggleClass("selected").siblings(".mini-panel").removeClass("selected"),b("#internet-block").hide(),b("#performance-panel").toggle(b("#performance-mini-panel").hasClass("selected")),b("#usb-panel").hide(),e.dashboardView.cpuLoad.resize(),e.dashboardView.memoryUsage.resize()}},"#usb-mini-panel":{click:function(){r.usbStorageStore.getData()&&r.usbStorageStore.getData().length&&(b("#usb-mini-panel").toggleClass("selected").siblings(".mini-panel").removeClass("selected"),b("#internet-block").hide(),b("#performance-panel").hide(),b("#usb-panel").toggle(b("#usb-mini-panel").hasClass("selected")))}},"#map-router-usb-button":{ev_button_click:function(e){l.navigatorController.goTo("storageSharing")}}}),this.listen({"models.statusAll":{ev_loaded:function(e,t){o.setStorage(t),o.setPerformance(t)}},"stores.connectedClientsStore":{ev_data_change:function(e,t,n){var a,i;"enablePriority"===n.getName()&&t.value!==t.oldValue&&(a=function(){i()&&(r.connectedClientsStore.abort(),r.connectedClientsStore.sync({success:function(e){r.connectedClientsStore.loadData(e,!0)}}))},i=function(){var e=d.moduleManager.get("bandwidth");return!!e.hasConfigured()||(t.value&&(o.stopGetClients(),e.showBandwithMsg()),!1)},"off"==s.priorityEnable.enable.getValue()&&t.value?l.main.confirm(b.su.CHAR.QOS.GAMING_DASHBOARD_NOTICE,function(){i()&&(s.priorityEnable.enable.setValue("on"),s.priorityEnable.setOnOff({success:function(){a(),s.priorityEnable.getOnOff()}}))},function(){r.connectedClientsStore.abort(),r.connectedClientsStore.load({data:{operation:"loadDevice"}})},b.su.CHAR.OPERATION.CONTINUE):a()),"timePeriod"==n.getName()&&t.value!=t.oldValue&&(r.connectedClientsStore.abort(),r.connectedClientsStore.sync())}}})}},function(l,d,a,n,e,i){var o,s=null,c=function(){for(var e=[],t=26;t--;)e.push(0);return e}(),u=function(){for(var e=[],t=26;t--;)e.push(0);return e}(),r=function(){for(var e=[],t=7;t--;)e.push(0);return e}(),p=function(){for(var e=[],t=7;t--;)e.push(0);return e}(),S=function(e,t){e=e||2e3,t=t||7;for(var n,a=new Date,i=[];t--;)i.unshift(("0"+(n=a).getHours()).slice(-2)+":"+("0"+n.getMinutes()).slice(-2)+":"+("0"+n.getSeconds()).slice(-2)),a=new Date(a-e);return i};return{speedRequestInterval:2e3,setStorage:function(e){var i={PB:b.su.CHAR.UNIT.PB,TB:b.su.CHAR.UNIT.TB,GB:b.su.CHAR.UNIT.GB,MB:b.su.CHAR.UNIT.MB,KB:b.su.CHAR.UNIT.KB,B:b.su.CHAR.UNIT.B};function o(e){return e&&e.toUpperCase()}e.usbStorages.length?(d.dashboardView.noUSBTips.hide(),d.dashboardView.USBFieldset.show(),b.each(e.usbStorages,function(e,t){var n=b.su.capacityToNum(t.available+i[o(t.availableUnit)]),a=b.su.capacityToNum(t.capacity+i[o(t.capacityUnit)]);t.usageRate=n/a*100}),b("#usb-panel").toggleClass("single-column",1===e.usbStorages.length),n.usbStorageStore.loadData(e.usbStorages,!0)):(d.dashboardView.noUSBTips.show(),d.dashboardView.USBFieldset.hide(),b("#usb-mini-panel").removeClass("selected"),b("#usb-panel").hide())},initSpeedtest:function(){d.dashboardView.internetSpeedUsage.setOption(l.calculateInternetSpeedOption()),d.dashboardView.speedTestMiniPanel.setField("uploadSpeed",0),d.dashboardView.speedTestMiniPanel.setField("downloadSpeed",0),d.dashboardView.speedTestMiniPanel.setField("uploadSpeedUnit",b.su.CHAR.DASHBOARD.KBPS),d.dashboardView.speedTestMiniPanel.setField("downloadSpeedUnit",b.su.CHAR.DASHBOARD.KBPS),d.dashboardView.internetSpeedUpload.setValue("0 "+b.su.CHAR.DASHBOARD.KBPS),d.dashboardView.internetSpeedDownload.setValue("0 "+b.su.CHAR.DASHBOARD.KBPS),i.timer.setInterval(l,function(){i.ajax.request({proxy:"internetStatusProxy",success:function(e){"CONNECTED"===e.internetStatus.toUpperCase()?(l.getInternetSpeed({success:function(e){l.setInternetSpeed(e)}}),d.dashboardView.speedTestPanel.show(),d.dashboardView.noInternetFieldset.hide()):(d.dashboardView.speedTestPanel.hide(),d.dashboardView.noInternetFieldset.show(),d.dashboardView.speedTestMiniPanel.setField("uploadSpeed",0),d.dashboardView.speedTestMiniPanel.setField("downloadSpeed",0),d.dashboardView.speedTestMiniPanel.setField("uploadSpeedUnit",b.su.CHAR.DASHBOARD.KBPS),d.dashboardView.speedTestMiniPanel.setField("downloadSpeedUnit",b.su.CHAR.DASHBOARD.KBPS))}})},l.speedRequestInterval,!0)},getInternetSpeed:function(e){var t,n;e&&(t=e.success,n=e.fail),a.internetSpeedModel.load({success:function(){t&&t(a.internetSpeedModel.getData())},fail:function(e){n&&n(e)}})},setInternetSpeed:function(e){var t,n,a,i,o=this.separateSpeed(e.upSpeed),s=this.separateSpeed(e.downSpeed),o=(d.dashboardView.speedTestMiniPanel.setField("uploadSpeed",o.value),d.dashboardView.speedTestMiniPanel.setField("uploadSpeedUnit",o.unit),d.dashboardView.speedTestMiniPanel.setField("downloadSpeed",s.value),d.dashboardView.speedTestMiniPanel.setField("downloadSpeedUnit",s.unit),d.dashboardView.internetSpeedUpload.setValue(o.value+" "+o.unit),d.dashboardView.internetSpeedDownload.setValue(s.value+" "+s.unit),S(l.speedRequestInterval,26)),s=(c.shift(),c.push(e.upSpeed/1024),u.shift(),u.push(e.downSpeed/1024),Math.max.apply(this,c.concat(u)));function r(e){var t=parseInt(e,10).toString().length,t=Math.max(t-2,0);return t=3*Math.pow(10,t),Math.ceil(e/t)*t}a=1024<=s?(s/=1024,t=b.map(c,function(e){return e/1024}),n=b.map(u,function(e){return e/1024}),i=b.su.CHAR.DASHBOARD.MBPS,r(s)):(t=c,n=u,i=b.su.CHAR.DASHBOARD.KBPS,Math.max(r(s),120)),d.dashboardView.internetSpeedUsage.setOption({xAxis:[{data:o}],yAxis:[{max:a,interval:a/3,axisLabel:{formatter:function(e,t){return a/3*t+i}}}],series:[{data:t},{data:n}]})},calculateInternetSpeedOption:function(e){return e=b.extend({title:"",color:"#ffcd08",name:"internetSpeed"},e),{title:{show:!1},grid:{top:10,right:30,left:72,bottom:40,containLabel:!1},xAxis:[{name:"",type:"category",axisLine:{show:!1},axisLabel:{show:!0,interval:4,margin:20,textStyle:{color:"rgba(255,255,255,0.8)",fontSize:12}},axisTick:{show:!1,alignWithLabel:!0},splitLine:{show:!0,interval:4,lineStyle:{color:"#4a3a3a"}},boundaryGap:!1,data:S(l.speedRequestInterval,26)}],yAxis:[{max:120,min:0,interval:40,offset:40,nameTextStyle:{color:"#005564"},type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{color:"#4a3a3a"}},axisLabel:{show:!0,align:"left",margin:24,textStyle:{color:"rgba(255,255,255,0.8)",fontSize:12},formatter:function(e,t){return e+b.su.CHAR.DASHBOARD.KBPS}}}],series:[{name:"upload",type:"line",smooth:!0,symbol:"none",zIndex:2,itemStyle:{normal:{color:"rgb(236,154,0)",borderColor:"rgb(236,154,0)"}},areaStyle:{normal:{color:"rgba(236,154,0,0.4)"}},lineStyle:{width:1},data:e.data},{name:"download",type:"line",smooth:!0,symbol:"none",zIndex:1,itemStyle:{normal:{color:"rgb(175,0,0)",borderColor:"rgb(175,0,0)"}},areaStyle:{normal:{color:"rgba(175,0,0,0.4)"}},lineStyle:{width:1},data:e.data}]}},initPerformance:function(){d.dashboardView.cpuLoad.setOption(l.calculateLineOption({title:b.su.CHAR.DASHBOARD.CPU_LOAD,color:"#ffcd08",tooltip:{backgroundColor:"rgba(236,154,0,0.4)"},areaColor:"rgba(255, 205, 8, 0.5)",name:b.su.CHAR.DASHBOARD.CPU_CORE_NUMBER+":"})),d.dashboardView.memoryUsage.setOption(l.calculateLineOption({title:b.su.CHAR.DASHBOARD.MEMORY_USAGE,color:"#ff0000",tooltip:{backgroundColor:"rgba(255, 0, 0, 0.8)"},areaColor:"rgba(175,0,0,0.4)"}))},setPerformance:function(e){var t=e.cpuUsage,e=e.memUsage,n=S(2e3,7);r.shift(),r.push(t),d.dashboardView.cpuLoad.setOption({xAxis:[{data:n}],series:{data:r}}),p.shift(),p.push(e),d.dashboardView.memoryUsage.setOption({xAxis:[{data:n}],series:{data:p}})},calculateLineOption:function(s){return{title:{show:!1,text:(s=b.extend({title:"",color:"#ffcd08",name:"",areaColor:"rgba(255, 205, 8, 0.5)"},s)).title,textStyle:{fontSize:13},left:20},grid:{top:10,right:0,left:40,bottom:10},tooltip:b.extend({show:!0,formatter:"{c}%",textStyle:{color:"#fff",fontSize:12,lineHeight:14,fontFamily:"Arial, Sans-Serif, Geneva, Verdana"},padding:[2.6,6],position:function(e,t,n,a,i){var o=(o="")+("<span>"+t.value+"%</span>")+('<span style="display:block;position:absolute;left:'+(i.contentSize[0]/2-3+"px")+";bottom:-6px;border-top:6px solid "+s.tooltip.backgroundColor+';border-left:3px solid transparent;border-right:3px solid transparent;border-bottom:none;background-color:transparent;width:0;height:0;line-height:14px;"></span>');return b(n).html(o),[e[0]-18.5,e[1]-40]}},s.tooltip),xAxis:[{name:"",nameLocation:"middle",nameTextStyle:{color:"#000"},type:"category",axisLine:{show:!1},axisLabel:{show:!1},axisTick:{show:!1},boundaryGap:!1,data:S(2e3,7)}],yAxis:[{max:100,min:0,interval:20,offset:32,nameTextStyle:{color:"#005564"},type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!1,lineStyle:{type:"dashed"}},axisLabel:{show:!0,align:"left",textStyle:{color:"rgba(255,255,255,0.8)",fontSize:12},formatter:function(e,t){return e+"%"}}}],series:[{name:"RX",type:"line",smooth:!0,symbol:"emptyCircle",symbolSize:6,showAllSymbol:!0,legendHoverLink:!1,itemStyle:{normal:{color:s.color,borderColor:s.color}},areaStyle:{normal:{color:s.areaColor}},lineStyle:{width:1},data:s.data}]}},initClients:function(){i.moduleLoader.load({module:"dashboard"},{module:"bandwidth"},d.dashboardView.qosBandwidthLoader,function(){var e=i.moduleManager.get("bandwidth");e.on("ev_qos_saved",function(e){n.connectedClientsStore.abort(),a.priorityEnable.enable.setValue("on"),a.priorityEnable.enable.record(),a.priorityEnable.setOnOff({preventSuccessEvent:!0}),n.connectedClientsStore.sync({success:function(e){n.connectedClientsStore.loadData(e,!0),t()}})}),e.on("ev_qos_save_close",function(e){n.connectedClientsStore.reset(),t()}),e.on("ev_qos_save_cancel",function(e){n.connectedClientsStore.reset(),t()})});var t=function(){clearInterval(s),s=setInterval(function(){n.connectedClientsStore.load({data:{operation:"loadSpeed"}})},1e4)};n.connectedClientsStore.load({data:{operation:"loadDevice"},success:function(e){n.connectedClientsStore.load({data:{operation:"loadSpeed"}})}}),t()},stopGetClients:function(){clearInterval(s)},getClients:function(){i.ajax.request({proxy:"clientStatusProxy",success:function(e){o=e,n.connectedClientsStore.load({data:{operation:"loadSpeed"}})}})},getAccessControlMode:function(e){var t;e&&(t=e.success),a.accessControl.load({success:function(e){t&&t(a.accessControl.getData())}})},blockDevice:function(e){i.ajax.request({proxy:"blockClientProxy",data:{mac:e},success:function(e){n.connectedClientsStore.load({operation:"loadDevice"})}})},beforeDestroy:function(){clearInterval(s)},getIPaddr:function(e){if(o)for(var t in o)for(var n=0,a=o[t].length;n<a;n++)if(o[t][n].macaddr==e)return o[t][n].ipaddr||"";return""},separateSpeed:function(e){var t={};return e/1024<1?(t.value=0===e?0:e/1024,t.unit=b.su.CHAR.DASHBOARD.KBPS):e/1024/1024<1?(t.value=e/1024,t.unit=b.su.CHAR.DASHBOARD.KBPS):(t.value=e/1024/1024,t.unit=b.su.CHAR.DASHBOARD.MBPS),t.value=parseFloat(t.value.toFixed(2)),t}}})}(jQuery);