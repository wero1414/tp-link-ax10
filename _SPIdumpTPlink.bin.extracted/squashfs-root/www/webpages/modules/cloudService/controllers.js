!function(a){a.su.moduleManager.define("cloudService",{deps:[],services:["ajax","device","moduleManager","moduleLoader","cloudEmmitter"],models:["modifyEmailModel","modifyPasswordModel","bindAccountModel"],stores:[],views:["cloudServiceView"],listeners:{ev_on_launch:function(e,o,n,t,i,u,d){},ev_before_destroy:function(e,o,n,t,i,u,d){o.beforeDestroy()}},init:function(e,o,n,t,i,u){this.control({".cloud-msg":{ev_msg_ok:e._onMsgConfirm,ev_msg_cancel:e.resetModel,ev_msg_close:e.resetModel},"#cloud-email-msg":{ev_msg_close:e.emailSentHandler,ev_msg_ok:e.emailSentHandler}})}},function(i,u,d,e,o,t){var n="",r={email:{msgName:"cloudModifyEmailMsg",model:"modifyEmailModel"},password:{msgName:"cloudModifyPasswordMsg",model:"modifyPasswordModel"},bind:{msgName:"cloudBindAccountMsg",model:"bindAccountModel"},unbind:{msgName:"cloudUnbindAccountMsg"},self_unbind:{msgName:"cloudUnbindAccountMsg"}};return{maxTryTimes:3,msgType:"",setMode:function(e){var o="",o="login"===(n=e)?"tpLogin":"index";i.mainModule=t.moduleManager.get("main"),i.indexModule=t.moduleManager.get(o)},getMode:function(){return n},init:function(e){u.cloudServiceView.cloudErrorLoader.hide(),u.cloudServiceView.cloudIframeField.hide(),i.showLoading();var o={name:"cloud-iframe"};o.mode=i.getMode(),o.loadFailCallback=i.loadFailCallback,o.loadSuccessCallback=i.loadSuccessCallback.bind(i,e),i.eventEmmitter=t.cloudEmmitter,i.eventEmmitter.init(o),i.eventEmmitter.on("ev_cloud_login",i._onCloudLogin),i.eventEmmitter.on("ev_cloud_msg",i._onShowMsg),i.eventEmmitter.on("ev_email_sent",i._onEmailSent),i.eventEmmitter.on("ev_update_code",i._onUpdateInfo),i.eventEmmitter.on("ev_msg_close",i._onMsgClose)},loadFailCallback:function(){i.mainModule.clearWaitingEvent(),t.moduleLoader.load({module:"cloudService"},{module:"cloudError"},u.cloudServiceView.cloudErrorLoader,function(){i.hideLoading(),t.moduleManager.get("cloudError").setMode(i.getMode())}),u.cloudServiceView.cloudErrorLoader.show(),u.cloudServiceView.cloudIframeField.hide()},loadSuccessCallback:function(e){i.hideLoading(),u.cloudServiceView.cloudIframeField.show(),e&&e()},showLoading:function(){"basic"!==i.getMode()&&i.indexModule&&i.indexModule.showLoading()},hideLoading:function(){i.indexModule&&i.indexModule.hideLoading()},checkCloudBindStatus:function(e,o){var n=e.proxy,e=e.data||{};t.ajax.request({proxy:n,method:"read",data:e,success:function(e){if("login"===i.getMode())return e.isbind?void((o=t.moduleManager.get("tpLogin"))&&o.doCloudLogin("login")):(i.postLoginStatus(!1),void i.indexModule.checkAdmin());var o=e.isbind?"login":"bind";i.doCloudLogin(o)},fail:function(e){i.postLoginStatus(!1)},error:function(){i.postLoginStatus(!1)}})},doCloudLogin:function(e,o){t.ajax.request({proxy:"userLoginProxy",data:{operation:e,token:a.su.userInfo.token},success:function(e){a.su.userInfo.role=e.role,localStorage.setItem("userInfo",a.su.DES3.encrypt(JSON.stringify(a.su.userInfo))),i.loginSuccessCallback(i.getMode())},fail:function(e){a.su.userInfo={},i.postLoginStatus(!1);e=e.data.errorcode;(e=e&&String(e).replace(/^-/,"E"))&&-1!=a.su.cloudErrorCode.indexOf(e)&&(u.cloudServiceView.cloudErrorPromptContent.setText(a.su.CHAR.ERROR[e]),u.cloudServiceView.cloudErrorPrompt.show())},error:function(){i.postLoginStatus(!1)}})},loginSuccessCallback:function(e){switch(e){case"qs":t.device.getConfig().supportUXPlan?t.moduleManager.get("quickSetup").goTo("qsUXPlan"):t.moduleManager.get("quickSetup").quit();break;case"adv":i.indexModule.changeTPLinkID(a.su.userInfo.username),i.postLoginStatus(!0);break;case"basic":i.indexModule.changeTPLinkID(a.su.userInfo.username)}},postLoginStatus:function(e){var o={};(o.status=e)&&(o.token=a.su.userInfo.token,o.role=a.su.userInfo.role),i.eventEmmitter.postMessage("ev_login_status",o)},resetModel:function(){var e=r[i.msgType].model;e&&d[e].reset(),i.msgType=""},emailSentHandler:function(){t.ajax.request({proxy:"cloudLogoutProxy",method:"write",success:function(){localStorage&&localStorage.setItem("token",""),location.href="/"}})},unbindCloudAccout:function(){t.ajax.request({proxy:"cloudUnbindProxy",method:"write",data:{token:a.su.userInfo.token,role:a.su.userInfo.role},success:function(e){t.ajax.request({proxy:"cloudLogoutProxy",method:"write",success:function(){localStorage&&localStorage.setItem("token",""),location.href="/"}})},fail:function(e,o,n){var t=o;o&&(t=String(o).replace(/^-/,"E"),o=a.su.CHAR.ERROR[t],"E5001"==t&&(o=a.su.CHAR.ERROR[t].replace("%email",e.data.ownerAccount)),u.cloudServiceView.cloudErrorPromptContent.setText(o),u.cloudServiceView.cloudErrorPrompt.show())}})},beforeDestroy:function(){i.eventEmmitter&&i.eventEmmitter.off()},_onUpdateInfo:function(e,o){localStorage&&localStorage.setItem("updateCC",a.su.userInfo.token)},_onEmailSent:function(e,o){o=a.su.CHAR.TP_LINK_CLOUD.ACTIVATION_EMAIL_SEND.replace("%email%",o.email);u.cloudServiceView.emailSentNote.setText(o),u.cloudServiceView.cloudEmailSentMsg.show()},_onShowMsg:function(e,o){var n,o=o.type;o&&r[o]&&(i.msgType=o,"cloudUnbindAccountMsg"===(n=r[o].msgName)&&(o="self_unbind"==o&&"0"==a.su.userInfo.role?a.su.CHAR.TP_LINK_CLOUD.UNBIND_OWNER_TIP:a.su.CHAR.TP_LINK_CLOUD.UNBIND_TIP,u.cloudServiceView.cloudUnbindNote.setText(o)),u.cloudServiceView[n].show())},_onMsgConfirm:function(e,o){var n,t=i.msgType;t&&r[t]&&("self_unbind"===t?i.unbindCloudAccout():(n=r[t].model)&&!d[n].validate()?o.preventDefault():((o={}).type=t,n&&(o.data=d[n].getData(),d[n].reset()),i.eventEmmitter.postMessage("ev_msg_close",o),i.msgType=""))},_onCloudLogin:function(e,o){a.su.userInfo.username=o.username,a.su.userInfo.token=o.token;var o=i.getMode(),n={};"login"===o?n.proxy="cloudBindStatusLoginProxy":(n.proxy="cloudBindStatusProxy",n.data={token:a.su.userInfo.token}),i.checkCloudBindStatus(n),"adv"===o&&(n=t.moduleManager.get("tpLinkCloud"))&&n.setPanelInstruction(!0)},_onMsgClose:function(e,o){var n;"basic"===i.getMode()&&(n=t.moduleManager.get("networkMap"))&&n.hideCloudMsg(function(){var e;localStorage.getItem("updateCC")&&(e=n.checkCloudInfo(),a.when(e).done(function(e){n.showCloudMsg(e)}))})}}})}(jQuery);