!function(s){s.su.moduleManager.define("localLogin",{services:["ajax"],models:["localLogin","localLoginControl","vercodeModel","resetPwdModel"],stores:[],views:["localLoginView"],deps:["login","main"],listeners:{ev_on_launch:function(e,o,n,l,t,i,a){n.localLoginView.noInternetTips.hide(),a.ajax.request({proxy:"keyProxy",success:function(e){e&&e.password&&(o.encryptKey=e.password)}}),i.login.supportCloud()?(n.localLoginView.switchToTp.show(),n.localLoginView.mainPanel.setTitle(s.su.CHAR.LOGIN.LOCAL_LOGIN)):(n.localLoginView.switchToTp.hide(),n.localLoginView.mainPanel.setTitle(s.su.CHAR.LOGIN.LOGIN)),a.ajax.request({proxy:"sysmodeLoginProxy",data:{operation:"read"},success:function(e){"ap"===e.mode?n.localLoginView.switchToTp.hide():n.localLoginView.switchToTp.show()}})}},init:function(n,l,t,e,o,i){this.control({"#local-login-pwd":{keyup:function(e){e.preventDefault(),13==e.keyCode&&(s(e.target).blur(),n.doLogin())}},"#local-login-button":{ev_button_click:function(){n.doLogin()}},".local-login-switch-to-tp":{click:function(e){i.ajax.request({proxy:"loginCheckInternetProxy",method:"read",success:function(e){o.login.goToChildModule("tpLogin")},fail:function(){l.localLoginView.noInternetTips.show(),l.localLoginView.noInternetTips.setText(s.su.CHAR.LOGIN.LOCAL_SWITCH_TP_NO_INTERNET_TIPS)},error:function(){l.localLoginView.noInternetTips.show(),l.localLoginView.noInternetTips.setText(s.su.CHAR.LOGIN.LOCAL_SWITCH_TP_NO_INTERNET_TIPS)}})}},".local-login-forget-pwd":{mousedown:function(){n.forgetPasswordHandler()}},"#send-code-btn":{ev_button_click:function(){l.localLoginView.sendCodeFailedNote.hide(),i.ajax.request({data:{operation:"read"},proxy:"sendCodeProxy",success:function(e){n.enableConfirm=!0,l.localLoginView.sendCodeBtn.disable(),l.localLoginView.sendCodeBtn.setText(n.receiveCodeTimeCount+s.su.CHAR.LOGIN.SEC),clearInterval(n.countDownTimer),n.countDownTimer=setInterval(function(){0<n.receiveCodeTimeCount?(n.receiveCodeTimeCount--,l.localLoginView.sendCodeBtn.setText(n.receiveCodeTimeCount+s.su.CHAR.LOGIN.SEC)):(clearInterval(n.countDownTimer),n.receiveCodeTimeCount=60,l.localLoginView.sendCodeBtn.enable(),l.localLoginView.sendCodeBtn.setText(s.su.CHAR.LOGIN.SEND))},1e3)},fail:function(){l.localLoginView.sendCodeFailedNote.show()}})}},"#confirm-code-btn":{ev_button_click:function(){n.enableConfirm&&(l.localLoginView.sendCodeFailedNote.hide(),t.vercodeModel.submit({success:function(e){n.vercode=e.vercode,l.localLoginView.forgetPasswordSendCodeMsg.hide(),t.resetPwdModel.password.setValue(),t.resetPwdModel.confirm.setValue(),l.localLoginView.resetPasswordMsg.show()},fail:function(e,o){t.vercodeModel.vercode.setError(),l.localLoginView.confirmCodeOverlimitNote.setText(s.su.CHAR.ERROR[o]),l.localLoginView.confirmCodeOverlimitMsg.show()},error:function(){t.vercodeModel.vercode.setError()}}))}},"#reset-pwd-btn":{ev_button_click:function(){var e;t.resetPwdModel.validate()&&(t.resetPwdModel.password.getValue()!=t.resetPwdModel.confirm.getValue()?t.resetPwdModel.confirm.setError(s.su.CHAR.ERROR["00000080"]):(e=t.resetPwdModel.password.doEncrypt(n.encryptKey),i.ajax.request({proxy:"forgetPasswordProxy",data:{operation:"write",password:e,confirm:!0,vercode:n.vercode},success:function(e){l.localLoginView.resetPasswordMsg.hide()}})))}},"#send-code-content":{ev_view_change:function(e,o){"value"===o.type&&(o=o.value,n.enableConfirm&&o?l.localLoginView.confirmCodeBtn.enable():l.localLoginView.confirmCodeBtn.disable())}},".find-local-pwd-jump-label":{click:function(){n.queryRecoveryPasswordMethod().then(function(e){e?o.login.goToChildModule("localPwdRecovery"):l.localLoginView.noRecoveryMethodMsg.show()})}},"#user-conflict-prompt":{ev_msg_ok:function(){var e=t.localLoginControl.password.doEncrypt(n.encryptKey);t.localLogin.password.setValue(e),t.localLogin.login({data:{operation:"login",confirm:!0},success:n.loginSuccessDealer,fail:n.loginFailDealer,error:n.loginErrorDealer})}}})}},function(i,a,r,e,t,n){var l=undefined;return{enableConfirm:!1,receiveCodeTimeCount:60,countDownTimer:null,encryptKey:null,vercode:"",doLogin:function(){var o,e;l||r.localLoginControl.validate()&&(o=r.localLoginControl.password.getValue(),e=r.localLoginControl.password.doEncrypt(i.encryptKey),r.localLogin.password.setValue(e),a.localLoginView.localLoginBtn.loading(!0),n.ajax.request({proxy:"authProxy",success:function(e){s.su.encryptor.setRSAKey(e.key[0],e.key[1]),s.su.encryptor.setSeq(e.seq),s.su.encryptor.genAESKey(),s.su.encryptor.setHash("admin",o),s.encrypt.encryptManager.recordEncryptor(),r.localLogin.login({preventFailEvent:!0,success:i.loginSuccessDealer,fail:i.loginFailDealer,error:i.loginErrorDealer})},error:i.loginErrorDealer}))},loginSuccessDealer:function(e,o){a.localLoginView.localLoginBtn.loading(!1);var n,l=e.stok||(e="12345",n=top.location.href,l=n.indexOf("stok="),e=0<=l?n.substring(l+5):e);localStorage&&(t.main.setToken(l),t.main.reload())},loginFailDealer:function(e,o){a.localLoginView.localLoginBtn.loading(!1);var n=!(e.data&&e.data.failureCount&&7<=e.data.failureCount);if(e.data&&e.data.hasOwnProperty("errorcode")&&n){n=String(e.data.errorcode).replace(/^-/,"E");r.localLoginControl.password.setErrorHtml(s.su.CHAR.ERROR[n])}else if(o)switch(o){case"user conflict":e.data.logined_user;a.localLoginView.userConflictMsgContent.setText(s.su.CHAR.LOGIN.USER_CONFLICT_MSG),a.localLoginView.userConflictMsg.show();break;case"login failed":s.su.IS_RG_SEC?i.handleSGLoginFailed(e):i.handleDefaultLoginFailed(e);break;case"exceeded max attempts":var l=e.data.failureCount,t=e.data.attemptsAllowed,t=s.su.CHAR.ERROR["00000089"].replace("%num",t+l);a.localLoginView.maxAttemptsMsgContent.setText(t),a.localLoginView.maxAttemptsMsg.show()}},loginErrorDealer:function(){t.main.reload()},queryRecoveryPasswordMethod:function(){var e=s.Deferred();return e.resolve(!0),e.promise()},forgetPasswordHandler:function(){n.ajax.request({proxy:"forgetPasswordProxy",success:function(e){e&&((e.enable_rec?(a.localLoginView.sendCodeFailedNote.hide(),r.vercodeModel.vercode.setNormal(),r.vercodeModel.vercode.setValue(),a.localLoginView.confirmCodeBtn.disable(),a.localLoginView.forgetPasswordSendCodeMsg):a.localLoginView.forgetPasswordMsg).show(),clearInterval(i.countDownTimer),i.receiveCodeTimeCount=60,a.localLoginView.sendCodeBtn.enable(),a.localLoginView.sendCodeBtn.setText(s.su.CHAR.LOGIN.SEND))}})},handleDefaultLoginFailed:function(e){var o,n=e.data.failureCount,e=e.data.attemptsAllowed;(0===e?(o=s.su.CHAR.ERROR["00000089"].replace("%num",e+n),a.localLoginView.maxAttemptsMsgContent.setText(o),a.localLoginView.maxAttemptsMsg):(e<=n?(o=(o=s.su.CHAR.LOGIN.LOGIN_FAILED_COUNT.replace("%num1",n)).replace("%num2",e),a.localLoginView.leftAttemptsMsgContent.setText(o)):a.localLoginView.leftAttemptsMsgContent.setText(s.su.CHAR.LOGIN.LOGIN_FAILED),a.localLoginView.leftAttemptsMsg)).show()},handleSGLoginFailed:function(e){var o=s.su.CHAR.LOGIN.LOGIN_FAILED_SG.replace("10",e.data.failureCount+e.data.attemptsAllowed).replace("%SEC%",e.data.failureCount);r.localLoginControl.password.setError(o),i.disableLoginBtn(e.data.remainTime||2)},disableLoginBtn:function(e){var o=s.su.CHAR.LOGIN.LOGIN_RETRY_SG;a.localLoginView.localLoginBtn.disable(),a.localLoginView.loginRetryNote.setText(o.replace("%SEC%",e)),a.localLoginView.loginRetryNote.show(),l=setInterval(function(){if(!--e)return i.enableLoginBtn();a.localLoginView.loginRetryNote.setText(o.replace("%SEC%",e))},1e3)},enableLoginBtn:function(){clearInterval(l),l=undefined,a.localLoginView.localLoginBtn.enable(),a.localLoginView.loginRetryNote.hide()}}})}(jQuery);