!function(c){c.su.moduleManager.define("tpLogin",{services:["moduleManager","ajax","moduleLoader","device"],stores:[],views:["tpLoginView"],deps:["main","utils"],models:["tpLoginControl"],listeners:{ev_on_launch:function(e,o,t,n,i,a,s){s.ajax.request({proxy:"keyProxy",success:function(e){e&&e.password&&(o.encryptKey=e.password)}}),t.tpLoginView.adminCheckPanel.hide(),c.su.userInfo={},o.supportCloudv3?(o.cloudModuleName="cloudService",t.tpLoginView.tpLoginPanel.hideTitle(),c("#login-card").addClass("cloud-v3")):o.cloudModuleName="tpCloud",s.moduleLoader.load({module:"tpLogin",view:"tpLoginView"},{module:o.cloudModuleName},t.tpLoginView.tpCloudLoader,function(){var e=s.moduleManager.get(o.cloudModuleName);e.setMode("login"),o.supportCloudv3?e.init():e.goTo("login&page=spfLogin")})}},init:function(e,o,t,n,i,a){this.control({"#login-bind-btn":{ev_button_click:function(){e.doCloudLogin("bind")}},".tp-login-switch-to-local":{click:function(){var e=a.moduleManager.get("login");e&&e.goToChildModule("localLogin")}},"#user-conflict-prompt2":{ev_msg_ok:function(){e.doCloudLogin("login",!0)}}})}},function(r,u,n,e,l,d){r=this;return{encryptKey:"",supportCloudv3:d.device.getConfig().supportCloudv3,unLoad:function(){d.moduleLoader.unLoad(u.tpLoginView.tpCloudLoader)},checkAdmin:function(){u.tpLoginView.tpLoginPanel.hide(),c(".tp-login-switch-to-local-container").hide(),u.tpLoginView.adminCheckPanel.show()},doCloudLogin:function(e,o){var t={operation:e,token:c.su.userInfo.token};if("bind"==e){if(!n.tpLoginControl.validate())return;t.password=n.tpLoginControl.password.doEncrypt(r.encryptKey)}var i=d.moduleManager.get(r.cloudModuleName);o&&(t.confirm=o),d.ajax.request({proxy:"authProxy",success:function(e){c.su.encryptor.setRSAKey(e.key[0],e.key[1]),c.su.encryptor.setSeq(e.seq),c.su.encryptor.genAESKey(),c.su.encryptor.setHash(c.su.userInfo.token),c.encrypt.encryptManager.recordEncryptor(),d.ajax.request({proxy:"cloudLoginProxy",data:t,isLogin:!0,success:function(e){var o,t,n=e.stok||(o="12345",t=top.location.href,n=t.indexOf("stok="),o=0<=n?t.substring(n+5):o);i.postLoginStatus(),c.su.userInfo.role=e.role,localStorage&&(l.main.setToken(n),localStorage.setItem("userInfo",c.su.DES3.encrypt(JSON.stringify(c.su.userInfo))),l.main.reload())},fail:r.loginFailDealer,error:i.postLoginStatus})},fail:i.postLoginStatus,error:i.postLoginStatus})},loginFailDealer:function(e,o){d.moduleManager.get(r.cloudModuleName).postLoginStatus(),u.tpLoginView.tpLoginBtn.loading(!1);var t=!(e.data&&e.data.failureCount&&7<=e.data.failureCount);if(e.data&&e.data.hasOwnProperty("errorcode")&&t){t=String(e.data.errorcode).replace(/^-/,"E");l.main.showNotice(c.su.CHAR.ERROR[t],1,1e4)}else if(o)switch(o){case"user conflict":u.tpLoginView.userConflictMsgContent2.setText(c.su.CHAR.LOGIN.USER_CONFLICT_MSG),u.tpLoginView.userConflictMsg2.show();break;case"login failed":var n=e.data.failureCount,i=(a=e.data.attemptsAllowed)+n;(0===a?(s=c.su.CHAR.ERROR["00000089"].replace("%num",i),u.tpLoginView.maxAttemptsMsgContent2.setText(s),u.tpLoginView.maxAttemptsMsg2):(a<=n?(s=(s=c.su.CHAR.LOGIN.LOGIN_FAILED_COUNT.replace("%num1",n)).replace("%num2",a),u.tpLoginView.leftAttemptsMsgContent2.setText(s)):u.tpLoginView.leftAttemptsMsgContent2.setText(c.su.CHAR.LOGIN.LOGIN_FAILED),u.tpLoginView.leftAttemptsMsg2)).show();break;case"exceeded max attempts":var a,n=e.data.failureCount,i=(a=e.data.attemptsAllowed)+n,s=c.su.CHAR.ERROR["00000089"].replace("%num",i);u.tpLoginView.maxAttemptsMsgContent2.setText(s),u.tpLoginView.maxAttemptsMsg2.show()}},showLoading:function(){l.main.showMask(),u.tpLoginView.cloudLoading.show()},hideLoading:function(){l.main.hideMask(),u.tpLoginView.cloudLoading.hide()}}})}(jQuery);