!function(s){s.su.moduleManager.define("administration",{models:["changePwdModel","pwdRecoveryModel","localMngtModel","localMngtHttpModel","newDeviceModel","remoteMngtModel","autoLogoutModel","lanAdvLanModel","ipv4Status"],stores:["localMngtDeviceStore","remoteMngtDeviceStore","allowDeviceStore","portForwardingConnectedDevicesStore"],services:["ajax","device"],deps:["utils"],views:["administrationView"],listeners:{ev_on_launch:function(e,i,t,o,n,a,d){s.su.IS_RG_SEC?(o.localMngtHttpModel.httpsEnable.hide(),o.localMngtHttpModel.httpsEnable.disable()):(o.localMngtHttpModel.httpsEnable.show(),o.localMngtHttpModel.httpsEnable.enable()),i.oldPwdKey=null,i.newPwdKey=null,i.cfmPwdKey=null,i.virtualPortList=[],"ap"===d.device.getCurrentMode()&&(t.administrationView.recoveryPanel.hide(),t.administrationView.remoteMngtCtn.hide()),t.administrationView.changePasswordPanel.show(),t.administrationView.recoveryPanel.show(),o.changePwdModel.load({success:function(){var e=o.changePwdModel.getData();i.oldPwdKey=e.oldPwd,i.newPwdKey=e.newPwd,i.cfmPwdKey=e.cfmPwd}}),o.ipv4Status.load({ajax:{"async":!1},success:function(){var e={dslite:s.su.CHAR.NETWORK_INTERNET.DSLITE_CONFLICT_TIPS,v6plus:s.su.CHAR.NETWORK_INTERNET.V6PLUS_CONFLICT_TIPS,ocn:s.su.CHAR.NETWORK_INTERNET.OCN_CONFLICT_TIPS}[o.ipv4Status.conntype.getValue()],t=o.remoteMngtModel.enable;e?(t.disable(),t.setTips(e),i.FEATURE_ENABLE=!1):t.enable()}}),o.localMngtModel.load(),o.localMngtHttpModel.load(),o.pwdRecoveryModel.load({success:function(e){i.recovertPwdKey=e.password}}),o.remoteMngtModel.load(),n.allowDeviceStore.load(),o.lanAdvLanModel.load({success:function(e){e=o.lanAdvLanModel.getData();switch(i.lanIP=e.ipaddr,e.maskType){case 0:i.lanMask="255.255.255.0";break;case 1:i.lanMask="255.255.0.0";break;case 2:i.lanMask="255.0.0.0";break;case 3:i.lanMask=e.customValue}}}),i.getVirtualPort({success:function(e){for(var t=0,o=e.length;t<o;t++){var n=e[t].enable,a=e[t].protocol.toUpperCase(),d=e[t].externalPort;"on"==n&&"UDP"!==a&&i.virtualPortList.push(d)}}})}},init:function(n,a,i,l,e,t){this.configViews({id:"administrationView",items:[{id:"allowed-devices-grid",configs:{minLines:0,tbar:{add:{text:s.su.CHAR.ADMINISTRATION.ADD_DEVICE,index:0}},popEditor:{addTitle:s.su.CHAR.ADMINISTRATION.ADD_DEVICE,content:"#allow-deivce-popEditor",fields:[{name:"description"},{name:"mac"}]},columns:[{xtype:"checkcolumn",width:20},{text:s.su.CHAR.ADMINISTRATION.DESCRIPTION,dataIndex:"description"},{text:s.su.CHAR.ADMINISTRATION.MAC,dataIndex:"mac"},{xtype:"actioncolumn",text:s.su.CHAR.ADMINISTRATION.OPERATION,renderer:function(e,t){var o="";return t.host||(o+='<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-delete btn-delete"><span class="icon"></span><span class="text"></span></a>'),o}}]}},{id:"connect-device-list",configs:[{type:"logo",dataIndex:"deviceType"},{type:"deviceName",dataIndex:"name"},{type:"mac",dataIndex:"macAddress"},{type:"ip",dataIndex:"ipAddress"}]}]}),this.listen({"models.pwdRecoveryModel.enableRec":{ev_value_change:function(e,t,o){"on"===t?a.administrationView.recoveryFieldset.show():a.administrationView.recoveryFieldset.hide()}},"models.pwdRecoveryModel.enableAuth":{ev_value_change:function(e,t,o){"on"===t?a.administrationView.recoveryAuthFieldset.show():a.administrationView.recoveryAuthFieldset.hide()}},"models.localMngtModel.mode":{ev_value_change:function(e,t,o){"all"===t?l.allowDeviceStore.hide():l.allowDeviceStore.show()}},"models.remoteMngtModel.enable":{ev_value_change:function(e,t,o){n.FEATURE_ENABLE&&"on"===t?(a.administrationView.remoteMngtFieldset.show(),i.remoteMngtModel.webAddress.enable(),"all"===i.remoteMngtModel.managers.getValue()?(i.remoteMngtModel.ipaddr.hide(),i.remoteMngtModel.ipaddr.disable()):(i.remoteMngtModel.ipaddr.show(),i.remoteMngtModel.ipaddr.enable())):(a.administrationView.remoteMngtFieldset.hide(),i.remoteMngtModel.webAddress.disable())}},"models.remoteMngtModel.managers":{ev_value_change:function(e,t){"all"===t?(i.remoteMngtModel.ipaddr.hide(),i.remoteMngtModel.ipaddr.disable()):(i.remoteMngtModel.ipaddr.show(),i.remoteMngtModel.ipaddr.enable())}},"models.changePwdModel":{ev_will_auto_save:function(e,t){i.changePwdModel.oldPwd.setValue(i.changePwdModel.oldPwdInput.doEncrypt(n.oldPwdKey)),i.changePwdModel.newPwd.setValue(i.changePwdModel.newPwdInput.doEncrypt(n.newPwdKey)),i.changePwdModel.cfmPwd.setValue(i.changePwdModel.cfmPwdInput.doEncrypt(n.cfmPwdKey))},ev_auto_saved:function(){s.encrypt.encryptManager.cleanStorage(),location.href="/"},ev_model_submit_complete:function(e,t,o){"update account failed"===o&&i.changePwdModel.oldPwdInput.setError(s.su.CHAR.ERROR.E5002)}},"models.pwdRecoveryModel":{ev_will_auto_save:function(e,t){i.pwdRecoveryModel.password.setValue(i.pwdRecoveryModel.passwordInput.doEncrypt(n.recovertPwdKey))}}}),this.control({".index-common-save-btn":{ev_will_auto_save:function(e,t){n.validatePassword()||t.preventDefault(),n.validateRemoteManagement()||t.preventDefault()}},"#allowed-devices-grid":{ev_grid_tbar_add:function(e,t){i.newDeviceModel.description.setValue(""),i.newDeviceModel.mac.setNormal()},ev_grid_before_save:function(e,t){for(var o=i.newDeviceModel.mac.getValue(),n=l.allowDeviceStore.getData(),a=0,d=n.length;a<d;a++)if(n[a].mac===o)return i.newDeviceModel.mac.setError(s.su.CHAR.ERROR["00000007"]),t.preventDefault(),!1}},"#connect-device-list":{ev_item_click:function(e,t){i.newDeviceModel.description.setValue(t.name),i.newDeviceModel.mac.setValue(t.macAddress),a.administrationView.connectDeviceMsg.hide()}},"#connect-device-btn":{ev_button_click:function(){l.portForwardingConnectedDevicesStore.load(),a.administrationView.connectDeviceMsg.show()}},"#remote-conflict-confirm":{ev_msg_ok:function(){for(var e=[i.changePwdModel,i.pwdRecoveryModel,i.localMngtModel,i.localMngtHttpModel,i.remoteMngtModel],t=e.length,o=0;o<t;o++)if(e[o].isDirty()&&!e[o].validate())return;for(o=0;o<t;o++)e[o].isDirty()&&e[o].submit()}}})}},function(d,i,l,e,r,n){return{FEATURE_ENABLE:!0,getCloudLogin:function(e){var t,o;e&&(t=e.success,o=e.fail),n.ajax.request({proxy:"checkFirstLoginProxy",success:function(e){t&&t(e)},fail:function(e){o&&o(e)}})},getVirtualPort:function(e){var t;e&&(t=e.success),n.ajax.request({proxy:"virtualPortProxy",success:function(e){t&&t(e)}})},conflictPort:function(e,t){e=parseInt(e,10);for(var o=0,n=t.length;o<n;o++)if(0<=t[o].indexOf("-")){var a=t[o].split("-");if(e>=parseInt(a[0],10)&&e<=parseInt(a[1],10))return!0}else if(e==parseInt(t[o],10))return!0;return!1},validatePassword:function(){var e,t,o=l.changePwdModel;return!(o.isDirty()&&(o.oldPwdInput.getValue(),e=o.newPwdInput.getValue(),t=o.cfmPwdInput.getValue(),!o.validate()||e!==t&&(o.cfmPwdInput.setError(s.su.CHAR.ERROR["00000080"]),1)))},validateRemoteManagement:function(){var e,t,o,n,a=l.remoteMngtModel;return!(a.isDirty()&&"off"!==l.remoteMngtModel.enable.getValue()&&(e=a.httpPort.getValue(),t=a.httpsPort.getValue(),o=a.managers.getValue(),n=a.ipaddr.getValue(),!a.validate()||("partial"===o&&r.utils.isSameNet(n,d.lanIP,d.lanMask)?(a.ipaddr.setError(s.su.CHAR.ERROR["00000056"]),1):parseInt(t,10)===parseInt(e,10)?(a.httpPort.setError(s.su.CHAR.ADMINISTRATION.HTTP_PORT_CONFLICT_2),1):d.conflictPort(e,d.virtualPortList)?(i.administrationView.remoteConflictConfirm.setContent(s.su.CHAR.ADMINISTRATION.HTTP_PORT_CONFLICT_1),i.administrationView.remoteConflictConfirm.show(),1):d.conflictPort(t,d.virtualPortList)&&(i.administrationView.remoteConflictConfirm.setContent(s.su.CHAR.ADMINISTRATION.HTTPS_PORT_CONFLICT_1),i.administrationView.remoteConflictConfirm.show(),1))))}}})}(jQuery);