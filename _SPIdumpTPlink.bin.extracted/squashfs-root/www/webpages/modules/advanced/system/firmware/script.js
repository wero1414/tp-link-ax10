!function(l){l.su.moduleManager.define("firmware",{models:["firmwareSetModel","onlineUpgradeModel","statusAll","autoUpgradeModel","timeSettings","wirelessSmartConn"],stores:["upgradeLogStore","autoUpdateTimeStore"],deps:["main","quickSetup"],services:["ajax","language","vtype","time","moduleManager","moduleLoader","device"],views:["firmwareView","firmwareQsView"],listeners:{ev_on_launch:function(e,r,n,o,t,a,i){r.loadMeshUpdateModule(),n.firmwareView.upgradeOption.hide(),o.firmwareSetModel.load({success:function(){var e=o.firmwareSetModel.getData(),e=(r.rebootTime=parseInt(1e3*e.totalTime||r.rebootTime,10),e.hardwareVersion);i.device.getConfig().supportFirmwareInfoReplace&&(e=e.replace("v1.0","v1.0/v1.20")),n.firmwareView.hardwareVersion.setValue(e)}}),o.onlineUpgradeModel.load(),o.statusAll.load({success:function(){var e=o.statusAll.getData(),r=e.wireless2gEnable,t=e.wireless5gEnable,a=e.wireless5g2Enable,e=e.wireless6gEnable;"on"===r?n.firmwareView.reconnect2g.show():n.firmwareView.reconnect2g.hide(),"on"===t?n.firmwareView.reconnect5g1.show():n.firmwareView.reconnect5g1.hide(),"on"===a?n.firmwareView.reconnect5g2.show():n.firmwareView.reconnect5g2.hide(),"on"===e?n.firmwareView.reconnect6g.show():n.firmwareView.reconnect6g.hide()}}),i.ajax.request({proxy:"checkWireTypeProxy",success:function(e){r.wireType=e.wire_type}}),r.setMode(null)},ev_before_destroy:function(){this.beforeDestroy()}},init:function(n,o,r,t,e,a){this.configViews({}),this.listen({"models.onlineUpgradeModel":{ev_loaded:function(){var e=r.onlineUpgradeModel.getData();o.firmwareView.checkUpgradesBtn.loading(!1),o.firmwareView.checkUpgradesBtn.hide(),e.latestFlag?(o.firmwareView.upgradeOption.hide(),o.firmwareView.checkUpgradesBtn.show(),o.firmwareView.checkUpgradesBtn.setTips(l.su.CHAR.FIRMWARE.FIRMWARE_UPTO_DATE)):(o.firmwareView.checkUpgradesBtn.hide(),o.firmwareView.checkUpgradesBtn.setTips(),o.firmwareView.upgradeOption.show())}},"models.onlineUpgradeModel.detail":{ev_value_change:function(e,r){r=(r=r.replace(/\\t/g," ")).replace(/\\'/g,"'");t.upgradeLogStore.loadData(r.split("\\n"),!0)}}}),this.control({"#firmware-check-upgrades-btn":{ev_button_click:function(){n.startCheckUpgrade()}},"#firmware-whats-new":{ev_button_click:function(){t.upgradeLogStore.toggle()}},"#online-upgrade-btn":{ev_button_click:function(){n.modeFlag="online",o.firmwareView.confirmUpgrade.show()}},"#manual-upgrade-file":{ev_file_change:function(e,r){var r=this.checkFileName(r,"bin"),t=o.firmwareView.firmwareFile;!0===r?t.setNormal():t.setError(r)}},"#local-upgrade-btn":{ev_button_click:function(){n.modeFlag="manual";var e=o.firmwareView.firmwareFile,r=e.getFileName(),r=this.checkFileName(r,"bin");!0===r?(e.setNormal(),o.firmwareView.confirmUpgrade.show()):e.setError(r)}},"#firmware-upgrade-msg":{ev_msg_ok:function(){"online"===n.modeFlag?n.startOnlineUpgrade():"manual"===n.modeFlag&&n.startLocalUpgrade()}},"#qs-upgrade-retry-btn":{ev_button_click:function(){n.startOnlineUpgrade()}},".qs-upgrade-skip-btn":{ev_button_click:function(){n.goToSummary()}},"#reconnect-msg":{ev_msg_ok:function(e,r){var t=l.Deferred(),a=o.firmwareView.reconnectMsg;r.preventDefault(),a.disableButton("ok"),n.checkRouter({success:function(){t.resolve()},fail:function(){t.resolve()},error:function(){t.reject()}}),t.then(function(){a.close(),a.enableButton("ok"),localStorage&&localStorage.setItem("token",""),window.location.href="/"},function(){a.enableButton("ok")})}}})}},function(n,o,i,e,s,c){var t=0,a=0,u=null;c.time.getHour24();return{isTriband:c.device.getIsTriband(),supportWifi6E:c.device.getConfig().supportWifi6E,smartConnEnable:"on"===i.wirelessSmartConn.smartEnable.getValue(),wireType:"",timeType:"",modeFlag:"",rebootTime:12e4,queryLocalInterval:!1,queryLocalIntervalMax:!1,queryOnlineIntervalMax:!1,queryOnlineInterval:!1,checkDownloadInterval:!1,MODE:{QUICK_SETUP:"qs",NETWORK_MAP:"networkMap"},setMode:function(e){u=e},getMode:function(){return u},setQsState:function(e){s.quickSetup.upgradeState=e},resetProBar:function(){o.firmwareView.proBar.stop(),o.firmwareView.proBar.reset(),o.firmwareView.progressbarWrap.hide()},startCheckUpgrade:function(){o.firmwareView.checkUpgradesBtn.setTips(),o.firmwareView.checkUpgradesBtn.setNormal(),o.firmwareView.checkUpgradesBtn.loading(!0);var e=l.Deferred(),r=l.Deferred();l.Deferred();n.detectInternet(function(){e.resolve()},function(){n.showCheckError(l.su.CHAR.ERROR["10000139"])},function(){n.showCheckError(l.su.CHAR.ERROR["10000139"])}),l.when(e).then(function(){n.detectDevice(function(){r.resolve()},function(){n.showUpgradeError()},function(){n.showUpgradeError()})}),l.when(r).then(function(){i.onlineUpgradeModel.load({fail:function(){n.showCheckError(l.su.CHAR.ERROR["10000193"])},error:function(){n.showCheckError(l.su.CHAR.ERROR["10000193"])}})})},goToSummary:function(){s.quickSetup.submitQsWirelssData()},startOnlineUpgrade:function(){var r,t=n.getMode(),e=(t!==n.MODE.QUICK_SETUP&&s.main.showProBar(l.su.CHAR.FIRMWARE.DOWNLOADING,l.su.CHAR.FIRMWARE.UPGRADE_PROCESS_TIP),l.Deferred()),a=l.Deferred();l(".qs-download-fail-icon").removeClass("upgrade"),o.firmwareQsView.qsFwUpgradeProgress.show(),o.firmwareQsView.qsFwUpgradeFail.hide(),o.firmwareQsView.qsFailNote.setText(l.su.CHAR.FIRMWARE.DOWNLOAD_FAIL),o.firmwareQsView.qsUpgradeRoad.setText(l.su.CHAR.FIRMWARE.TRY_AGAIN),o.firmwareQsView.qsUpgradeDownloadBtns.show(),o.firmwareQsView.qsUpgradeNextBtn.hide(),t===n.MODE.QUICK_SETUP?(errorHandler=this.qsErrorHandler.bind(this),r=this.qsErrorHandler.bind(this)):t===n.MODE.NETWORK_MAP?(errorHandler=s.main.showError,r=s.main.showError,l.su.moduleManager.get("networkMap").beforeDestroy()):(errorHandler=n.showCheckError,r=n.showOnlineUpgradeError),n.detectInternet(function(){e.resolve()},function(){s.main.hideProBar(),errorHandler(l.su.CHAR.ERROR["10000139"])},function(){s.main.hideProBar(),errorHandler(l.su.CHAR.ERROR["10000139"])}),l.when(e).then(function(){n.detectDevice(function(){a.resolve()},function(){s.main.hideProBar(),errorHandler(l.su.CHAR.ERROR["10000139"])},function(){s.main.hideProBar(),errorHandler(l.su.CHAR.ERROR["10000139"])})}),l.when(a).then(function(){i.onlineUpgradeModel.getProxy().upgrade({success:function(e){t===n.MODE.QUICK_SETUP&&n.setUpgradedValue(!0),n.detectDownloadStatus()},fail:function(e){r(l.su.CHAR.ERROR["10000194"])},error:function(){r(l.su.CHAR.ERROR["10000194"])}})})},qsErrorHandler:function(){this.setQsState("upgradeFailed"),o.firmwareQsView.qsFwUpgradeProgress.hide(),o.firmwareQsView.qsFwUpgradeFail.show()},startLocalUpgrade:function(){o.firmwareView.proBar.reset(),o.firmwareView.proBarTitle.setText(l.su.CHAR.FIRMWARE.UPLOADING),o.firmwareView.proBarTips.setText(l.su.CHAR.FIRMWARE.UPGRADE_PROCESS_TIP),o.firmwareView.confirmUpgrade.hide(),o.firmwareView.progressbarWrap.show(),c.ajax.upload({proxy:"uploadFirmwareProxy",fileId:"manual-upgrade-file",timeout:72e4,success:function(e){o.firmwareView.confirmUpgrade.hide(),n.queryLocalInterval||(o.firmwareView.proBarTitle.setText(l.su.CHAR.FIRMWARE.UPGRADING),o.firmwareView.proBar.reset(),o.firmwareView.progressbarWrap.show(),clearInterval(n.queryLocalInterval),n.queryLocalInterval=setInterval(n.detectLocalUpgradeStatus,1e3),o.firmwareView.proBar.animate({percentageStart:0,percentageEnd:100,duration:1e3*i.firmwareSetModel.upgradetime.getValue(),callback:function(){clearInterval(n.queryLocalInterval),n.resetProBar(),n.startReboot(n.rebootTime,!0)}}))},fail:function(e){o.firmwareView.progressbarWrap.hide(),clearInterval(n.queryLocalInterval),n.queryLocalInterval=null,n.showUpgradeFailedMsg("err_flash")},error:function(){o.firmwareView.progressbarWrap.hide(),clearInterval(n.queryLocalInterval),n.queryLocalInterval=null,n.showUpgradeFailedMsg("err_flash")}})},detectInternet:function(r,t,a){c.ajax.request({proxy:"checkInternetProxy",success:function(e){r&&r(e)},fail:function(e){t&&t(e)},error:function(e){a&&a(e)}})},detectDevice:function(r,t,a){c.ajax.request({proxy:"checkDeviceProxy",success:function(e){r&&r(e)},fail:function(e){t&&t(e)},error:function(e){a&&a(e)}})},detectDownloadStatus:function(){var r=this.getMode();o.firmwareView.confirmUpgrade.hide(),clearInterval(n.checkDownloadInterval),n.checkDownloadInterval=setInterval(function(){c.ajax.request({proxy:"checkDownloadStatusProxy",success:function(e){t=0;e=parseInt(e.percent,10);r===n.MODE.QUICK_SETUP?o.firmwareQsView.qsFwUpgradeBar.setValue(e):s.main.setProBarValue(e),100===e&&(clearInterval(n.checkDownloadInterval),n.checkDownloadInterval=null,setTimeout(n.detectOnlineUpgradeStatus,1e3))},fail:function(e){15===++t&&(t=0,clearInterval(n.checkDownloadInterval),n.checkDownloadInterval=null,s.main.hideProBar(),u===n.MODE.QUICK_SETUP?(n.setUpgradedValue(!1),n.qsErrorHandler()):((e=e.errorcode)&&(e=e.toString().replace(/^-/,"E"),s.main.setUpgradeRetryContent(l.su.CHAR.ERROR[e])),s.main.setUpgradeRetryContent(l.su.CHAR.ERROR["10000191"]),s.main.showUpgradeRetry()))},error:function(){15===++t&&(t=0,clearInterval(n.checkDownloadInterval),n.checkDownloadInterval=null,s.main.hideProBar(),u===n.MODE.QUICK_SETUP?(n.setUpgradedValue(!1),n.qsErrorHandler()):(s.main.setUpgradeRetryContent(l.su.CHAR.ERROR["10000191"]),s.main.showUpgradeRetry()))}})},1e3)},detectOnlineUpgradeStatus:function(){l(".qs-download-fail-icon").addClass("upgrade"),o.firmwareQsView.qsFailNote.setText(l.su.CHAR.FIRMWARE.UPGRADE_FAIL_NOTE),o.firmwareQsView.qsUpgradeRoad.setText(l.su.CHAR.FIRMWARE.UPGRADE_FAIL_ROAD),o.firmwareQsView.qsUpgradeDownloadBtns.hide(),o.firmwareQsView.qsUpgradeNextBtn.show();var r=n.getMode(),t=(r!==n.MODE.QUICK_SETUP&&s.main.showProBar(l.su.CHAR.FIRMWARE.UPGRADING,l.su.CHAR.FIRMWARE.UPGRADE_PROCESS_TIP),o.firmwareQsView.qsFwUpgradeBar.reset(),o.firmwareQsView.qsFwUpgradeBar.setText(l.su.CHAR.FIRMWARE.UPGRADING),clearInterval(n.queryOnlineInterval),!1);r===n.MODE.QUICK_SETUP?o.firmwareQsView.qsFwUpgradeBar.animate({percentageStart:0,percentageEnd:100,duration:1e3*i.firmwareSetModel.upgradetime.getValue(),callback:function(){clearInterval(n.queryOnlineInterval),n.queryOnlineInterval=null,n.setQsState("upgradeSucceed"),s.quickSetup.submitQsWirelssData({success:function(){o.firmwareQsView.qsFwUpgradeBar.setText(l.su.CHAR.FIRMWARE.REBOOTING),o.firmwareQsView.qsFwUpgradeBar.animate({percentageStart:0,percentageEnd:100,duration:n.rebootTime,callback:function(){localStorage&&localStorage.setItem("token",""),s.quickSetup.goTo("qsSummary")}})}})}}):s.main.setProBarAnimate(i.firmwareSetModel.upgradetime.getValue(),function(){clearInterval(n.queryOnlineInterval),n.queryOnlineInterval=null,s.main.hideProBar(),n.resetProBar(),t||n.startReboot(n.rebootTime,!0),t=!0}),n.queryOnlineInterval=setInterval(function(){c.ajax.request({proxy:"checkUpgradeStatusProxy",success:function(e){a=0,100===parseInt(e.percent,10)&&(clearInterval(n.queryOnlineInterval),n.queryOnlineInterval=null,s.main.hideProBar(),r===n.MODE.QUICK_SETUP?(n.setQsState("upgradeSucceed"),s.quickSetup.submitQsWirelssData({success:function(){o.firmwareQsView.qsFwUpgradeBar.setText(l.su.CHAR.FIRMWARE.REBOOTING),o.firmwareQsView.qsFwUpgradeBar.animate({percentageStart:0,percentageEnd:100,duration:n.rebootTime,callback:function(){localStorage&&localStorage.setItem("token",""),s.quickSetup.goTo("qsSummary")}})}})):(n.resetProBar(),t||n.startReboot(n.rebootTime,!0),t=!0))},fail:function(e){e=e.errorcode;15===++a&&(a=0,clearInterval(n.queryOnlineInterval),n.queryOnlineInterval=null,s.main.hideProBar(),u===n.MODE.QUICK_SETUP?(n.setUpgradedValue(!1),n.qsErrorHandler()):("err_reboot"===e?s.main.setUpgradeRetryContent(l.su.CHAR.ERROR["00000005_UPGRADE"]):s.main.setUpgradeRetryContent(l.su.CHAR.ERROR["10000192_UPGRADE"]),s.main.showUpgradeRetry()))}})},1e3)},detectLocalUpgradeStatus:function(){function e(e){n.queryLocalInterval&&(clearInterval(n.queryLocalInterval),n.queryLocalInterval=null,n.resetProBar(),n.showUpgradeFailedMsg(e.errorcode))}c.ajax.request({proxy:"checkUpgradeStatusProxy",success:function(e){100===parseInt(e.percent,10)&&(clearInterval(n.queryLocalInterval),n.queryLocalInterval=null,n.resetProBar(),n.startReboot(n.rebootTime,!0))},fail:e,error:e})},startReboot:function(e,r){s.main.startReboot(e,function(){localStorage&&localStorage.setItem("token",""),n.getMode()==n.MODE.NETWORK_MAP&&localStorage.setItem("upgradeSuccess","1"),"wired"==n.wireType?window.location.href="/":(o.firmwareView.reconnectMsg.show(),n.handleReconnectMsgContent())},r?l.su.CHAR.FIRMWARE.UPGRADE_PROCESS_TIP:"")},handleReconnectMsgContent:function(){n.smartConnEnable?(o.firmwareView.reconnect5g1.hide(),o.firmwareView.reconnect5g2.hide(),n.isTriband?o.firmwareView.cardTitle2g.setLabelField(l.su.CHAR.NETWORK_MAP.WIRELESS_2G5G12GHZ):o.firmwareView.cardTitle2g.setLabelField(l.su.CHAR.NETWORK_MAP.WIRELESS_2G5GGHZ)):n.isTriband?(o.firmwareView.reconnect5g1.setLabelField(l.su.CHAR.NETWORK_MAP.WIRELESS_5GHZ_1),o.firmwareView.reconnect5g2.show()):(o.firmwareView.reconnect5g1.setLabelField(l.su.CHAR.NETWORK_MAP.WIRELESS_5GHZ),o.firmwareView.reconnect5g2.hide()),n.supportWifi6E?o.firmwareView.reconnect6g.show():o.firmwareView.reconnect6g.hide()},checkFileName:function(e,r){return c.vtype.validate(e,{vtype:"string_file",extension:r})},showCheckError:function(e){o.firmwareView.upgradeOption.hide(),o.firmwareView.checkUpgradesBtn.show(),o.firmwareView.checkUpgradesBtn.loading(!1),o.firmwareView.checkUpgradesBtn.setError(e)},showOnlineUpgradeError:function(e){o.firmwareView.onlineUpgradeBtn.setError(e)},showUpgradeError:function(){o.firmwareView.checkUpgradesBtn.loading(!1),o.firmwareView.upgradeErrorMsg.show()},showUpgradeFailedMsg:function(e){switch(e){case"err_form":o.firmwareView.upgradeFailMsg.setContent(l.su.CHAR.ERROR["00000001"]);break;case"err_check":o.firmwareView.upgradeFailMsg.setContent(l.su.CHAR.ERROR["00000002"]);break;case"err_sizex":o.firmwareView.upgradeFailMsg.setContent(l.su.CHAR.ERROR["00000003"]);break;case"err_flash":o.firmwareView.upgradeFailMsg.setContent(l.su.CHAR.ERROR["00000004"]);break;case"err_reboot":o.firmwareView.upgradeFailMsg.setContent(l.su.CHAR.ERROR["00000005"]);break;case"err_other":o.firmwareView.upgradeFailMsg.setContent(l.su.CHAR.ERROR["00000006"]);break;case"err_failed":o.firmwareView.upgradeFailMsg.setContent(l.su.CHAR.ERROR["10000192"])}o.firmwareView.upgradeFailMsg.show()},failureRetry:function(){var r=this;i.onlineUpgradeModel.getProxy().upgrade({success:function(e){r.getMode()!==r.MODE.QUICK_SETUP&&s.main.showProBar(l.su.CHAR.FIRMWARE.DOWNLOADING,l.su.CHAR.FIRMWARE.UPGRADE_PROCESS_TIP),r.detectDownloadStatus()},fail:function(e){r.showOnlineUpgradeError(l.su.CHAR.ERROR["10000191"])},error:function(){r.showOnlineUpgradeError(l.su.CHAR.ERROR["10000191"])}})},removeInterval:function(){clearInterval(n.queryLocalInterval),n.queryLocalInterval=null,clearInterval(n.queryOnlineInterval),n.queryOnlineInterval=null,clearInterval(n.checkDownloadInterval),n.checkDownloadInterval=null,o.firmwareView.proBar.stop()},beforeDestroy:function(){n.removeInterval()},setUpgradedValue:function(e){c.ajax.request({proxy:"firmwareProxy",method:"write",data:{upgraded:e}})},checkRouter:function(e){var r,t,a;e&&(r=e.success,t=e.fail,a=e.error),c.ajax.request({proxy:"checkRouterProxy",success:function(e){r&&r(e)},fail:function(e){t&&t(e)},error:function(e){a&&a(e)}})},loadMeshUpdateModule:function(){var e=c.moduleManager.get("navigatorController");"firmware"===(!!e&&e.getCurrentPage())&&"router"===c.device.getCurrentMode()&&c.moduleLoader.load({module:"firmware"},{module:"meshUpdate"},o.firmwareView.meshUpdateLoader)}}})}(jQuery),$.su.modelManager.define("firmwareSetModel",{type:"model",fields:[{name:"firmwareVersion",mapping:"firmware_version"},{name:"hardwareVersion",mapping:"hardware_version"},{name:"country"},{name:"isDefault",mapping:"is_default"},{name:"model"},{name:"multiProgressbar",mapping:"multi_progressbar"},{name:"region"},{name:"sid"},{name:"totalTime",mapping:"totaltime"},{name:"upgradetime"}],proxy:"firmwareUpgradeProxy"}),$.su.modelManager.define("onlineUpgradeModel",{type:"model",fields:[{name:"latestVersion",mapping:"latest_version"},{name:"detail"},{name:"latestFlag",mapping:"latest_flag"}],preventSuccessEvent:!0,preventFailEvent:!0,preventErrorEvent:!0,proxy:"onlineUpgradeProxy"}),$.su.modelManager.define("autoUpgradeModel",{type:"model",fields:[{name:"enable"},{name:"time",mapping:"time"}],proxy:{url:$.su.url("/admin/firmware?form=auto_upgrade")}}),$.su.storeManager.define("upgradeLogStore",{type:"store",fields:[{name:"content"}],convert:function(e){return $.map(e,function(e){return{content:e}})},proxy:"onlineUpgradeProxy"}),$.su.define("firmwareUpgradeProxy",{extend:"IPFProxy",url:$.su.url("/admin/firmware?form=upgrade"),preventSuccessEvent:!0,preventFailEvent:!0,preventErrorEvent:!0}),$.su.define("onlineUpgradeProxy",{extend:"IPFProxy",url:$.su.url("/admin/cloud_account?form=cloud_upgrade"),preventSuccessEvent:!0,preventFailEvent:!0,preventErrorEvent:!0,api:{upgrade:{preventSuccessEvent:!0,preventFailEvent:!0,preventErrorEvent:!0,writeFilter:function(e){return $.extend({operation:"upgrade"},e)}}}}),$.su.define("checkUpgradeNumberProxy",{extend:"IPFProxy",url:$.su.url("/admin/cloud_account?form=check_upgrade"),preventSuccessEvent:!0,preventFailEvent:!0,preventErrorEvent:!0,writeFilter:function(e){return $.extend({operation:"read"},e)}}),$.su.define("checkDeviceProxy",{extend:"IPFProxy",url:$.su.url("/admin/cloud_account?form=check_device"),preventSuccessEvent:!0,preventFailEvent:!0,preventErrorEvent:!0,writeFilter:function(e){return $.extend({operation:"read"},e)}}),$.su.define("checkCloudConnectionProxy",{extend:"IPFProxy",url:$.su.url("/admin/cloud_account?form=check_connection"),preventSuccessEvent:!0,preventFailEvent:!0,preventErrorEvent:!0,writeFilter:function(e){return $.extend({operation:"read"},e)}}),$.su.define("checkDownloadStatusProxy",{extend:"IPFProxy",url:$.su.url("/admin/cloud_account?form=detect_upgrade_status"),preventSuccessEvent:!0,preventFailEvent:!0,preventErrorEvent:!0,writeFilter:function(e){return $.extend({operation:"read"},e)}}),$.su.define("checkUpgradeStatusProxy",{extend:"IPFProxy",url:$.su.url("/admin/firmware?form=upgrade"),preventSuccessEvent:!0,preventFailEvent:!0,preventErrorEvent:!0,writeFilter:function(e){return $.extend({operation:"fwup_check"},e)}}),$.su.define("uploadFirmwareProxy",{extend:"IPFProxy",api:{upload:{url:$.su.url("/admin/firmware?form=save_upgrade"),preventSuccessEvent:!0,preventFailEvent:!0,preventErrorEvent:!0,writeFilter:function(e){return $.extend({operation:"firmware",keep:"on"},e)}}}}),$.su.define("checkWireTypeProxy",{extend:"IPFProxy",url:$.su.url("/admin/quick_setup?form=quick_setup"),preventSuccessEvent:!0,preventFailEvent:!0,preventErrorEvent:!0,writeFilter:function(e){return $.extend({operation:"read"},e)}}),function(u){u.su.moduleManager.define("meshUpdate",{deps:[],services:["ajax","moduleManager"],models:["meshEnableModel"],stores:["meshRouterStore"],views:["meshUpdateView"],listeners:{ev_on_launch:function(e,r,t,a,n,o,i){r.initMeshUpdate()}},init:function(t,a,e,n,r,o){this.configViews({id:"meshUpdateView",items:[{id:"grid-mesh-routers",configs:{paging:{items:[{name:"6",value:6,selected:!0}]},columns:[{text:u.su.CHAR.ONE_MESH.DEVICE_NAME,dataIndex:"name",cls:"l-hide xl-hide"},{text:u.su.CHAR.COMMON.TYPE,dataIndex:"type",cls:"s-hide m-hide",width:60,renderer:function(e,r){var t="";return t+'<div class="device-type-container widget-container">'+('<span class="icon icon-'+e+'"></span>')+('<span class="'+(r.isLatest?"hidden":"red-point")+'"></span>')+"</div>"}},{text:u.su.CHAR.ONE_MESH.DEVICE_NAME,dataIndex:"name",cls:"s-hide m-hide"},{text:u.su.CHAR.ONE_MESH.MODEL,dataIndex:"model"},{text:u.su.CHAR.FIRMWARE.FIRMWARE_VERSION,dataIndex:"version",width:160},{xtype:"actioncolumn",text:u.su.CHAR.FIRMWARE.LATEST_FIRMWARE_VERSION,cls:"static-action-column",dataIndex:"isLatest",width:160,renderer:function(e,r){return e?"---":r.latestVersion+'<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-release btn-release">'+'<span class="icon">'+u.su.CHAR.FIRMWARE.WHATS_NEW+"</span></a>"}},{xtype:"actioncolumn",text:u.su.CHAR.FIRMWARE.UPGRADE_LOWER,dataIndex:"isLatest",width:60,renderer:function(e){var r="";return(r+='<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-update btn-update '+(e?"disabled":"")+'">')+'<span class="icon"></span>'+"</a>"}}]}}]}),this.control({"#grid-mesh-routers => a.btn-release":{ev_grid_action_click:function(e,r){r=n.meshRouterStore.getModelByKey(r).getData();t.setReleaseContent(r),a.meshUpdateView.meshReleaseMsg.show()}},"#grid-mesh-routers => a.btn-update":{ev_grid_action_click:function(e,r){r=n.meshRouterStore.getModelByKey(r).getData();r.isLatest||(t.deviceInfo.mac=r.mac,t.deviceInfo.ip=r.ip,t.deviceInfo.name=r.name,a.meshUpdateView.meshUpdateMsg.show())}},"#mesh-update-check-btn":{ev_button_click:function(){a.meshUpdateView.upToDateNote.hide(),a.meshUpdateView.meshUpdateCheckBtn.loading(!0),t.loadMeshRouterStore().always(function(){a.meshUpdateView.meshUpdateCheckBtn.loading(!1)})}},"#mesh-update-msg":{ev_msg_ok:t.generateUpdateTask}})}},function(a,e,r,n,t,o){var i="none",s="fail",c=e.meshUpdateView;return{deviceInfo:{},updateStatus:i,initMeshUpdate:function(){u.su.Model.promiseLoad(r.meshEnableModel).then(function(e){return"on"==e.enable}).then(function(e){e?(a.loadMeshRouterStore(),a.configDisplay(),c.updatePanel.show()):c.updatePanel.hide()})},loadMeshRouterStore:function(){return u.su.Model.promiseLoad(n.meshRouterStore,{operation:"slave_get_info"}).then(function(){var e=function(){for(var e=n.meshRouterStore.getSize(),r=0<e,t=0;t<e;t++)if(!n.meshRouterStore.getModelByIndex(t).isLatest.getValue())return{hasDevices:r,toBeUpdated:!0};return{hasDevices:r,toBeUpdated:!1}}();e.hasDevices?(c.btnContainer.show(),e.toBeUpdated?c.upToDateNote.hide():c.upToDateNote.show()):c.btnContainer.hide()})},configDisplay:function(){u.su.serviceManager.get("device").getConfig().supportOneMesh.includes("easyMesh")&&(c.updatePanel.setTitle(u.su.CHAR.EASY_MESH_UPDATE.SATELLITE_TITLE),c.updatePanel.setInstruction(u.su.CHAR.EASY_MESH_UPDATE.SATELLITE_NOTE),n.meshRouterStore.setEmptyText(u.su.CHAR.EASY_MESH_UPDATE.NO_ROUTER))},setReleaseContent:function(e){e=e.releaseNote.replace(/\\\\/g,"&#92;").replace(/\\n/g,"<br>");c.meshReleaseMsg.setContent(e)},generateUpdateTask:function(){var e=[a.checkInternet,a.startUpdateTask,a.startDownload];a.updateStatus=i,e.reduce(function(e,r){return e.then(r).fail(a.updateFailCallback)},u.Deferred().resolve())},checkInternet:function(){var e=u.Deferred();return o.ajax.request({proxy:"checkInternetProxy",success:function(){e.resolve()},fail:function(){e.reject()},error:function(){e.reject()}}),e},startUpdateTask:function(){var e=u.Deferred();return o.ajax.request({proxy:"meshUpdateProxy",data:{ip:a.deviceInfo.ip,mac:a.deviceInfo.mac},success:function(){e.resolve()},fail:function(){e.reject()},error:function(){e.reject()}}),e},startDownload:function(){c.meshDownloadingMsg.show();var r=u.Deferred();return function t(){o.ajax.request({proxy:"meshUpdateCheckProxy",data:{ip:a.deviceInfo.ip,mac:a.deviceInfo.mac},success:function(e){switch(e.status){case"upgrading":a.waitForUpdate(e.time||150),r.resolve();break;case"fail":r.reject();break;default:setTimeout(t,1e3)}},fail:function(){r.reject()},error:function(){r.reject()}})}(),r},waitForUpdate:function(e){c.meshDownloadingMsg.hide(),c.meshUpdatingMsg.show(),c.meshProgress.reset(),c.meshProgress.animate({duration:1e3*e,percentageStart:0,percentageEnd:100,callback:a.updateSuccessCallback})},updateSuccessCallback:function(){var e=u.su.CHAR.FIRMWARE.MESH_UPDATE_SUCCESS.replace("%modelName%",a.deviceInfo.name);c.meshUpdatingMsg.hide(),a.showNotice(e),a.loadMeshRouterStore()},updateFailCallback:function(){var e;a.updateStatus!=s&&(a.updateStatus=s,e=u.su.CHAR.FIRMWARE.MESH_UPDATE_FAIL.replace("%modelName%",a.deviceInfo.name),c.meshDownloadingMsg.hide(),c.meshUpdatingMsg.hide(),a.showNotice(e,1))},showNotice:function(e,r){var t=o.moduleManager.get("main");t&&t.showNotice(e,r)}}})}(jQuery),function(r){r.su.storeManager.define("meshRouterStore",{type:"store",fields:[{name:"type",convert:function(e){e=e.toLowerCase();return-1<e.indexOf("range")||-1<e.indexOf("re")?"rangeextender":-1<e.indexOf("deco")?"deco":"router"}},{name:"name"},{name:"model"},{name:"version"},{name:"isLatest",mapping:"is_latest"},{name:"latestVersion",mapping:"latest_version"},{name:"releaseNote"},{name:"mac"},{name:"ip"}],proxy:{extend:"IPFProxy",url:r.su.url("/admin/firmware?form=slave_cmd"),preventSuccessEvent:!0,preventFailEvent:!0,preventErrorEvent:!0}}),r.su.define("meshUpdateProxy",{extend:"IPFProxy",url:r.su.url("/admin/firmware?form=slave_cmd"),preventSuccessEvent:!0,preventFailEvent:!0,preventErrorEvent:!0,writeFilter:function(e){return r.extend({operation:"slave_upgrade_firmware"},e)}}),r.su.define("meshUpdateCheckProxy",{extend:"IPFProxy",url:r.su.url("/admin/firmware?form=slave_cmd"),preventSuccessEvent:!0,preventFailEvent:!0,preventErrorEvent:!0,writeFilter:function(e){return r.extend({operation:"slave_get_upgrade_info"},e)}})}(jQuery);