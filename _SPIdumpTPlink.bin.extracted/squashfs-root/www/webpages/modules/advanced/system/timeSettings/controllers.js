!function(g){g.su.moduleManager.define("timeSettings",{models:["timeSettings","language","daylight","time24Model","autoUpgradeModel"],stores:["languageStore","setTimeHourStore","setTimeMinStore","setTimeSecStore","startMonthStore","startWeekStore","startWeekdayStore","startHourStore","setTimeModeStore","timezoneStore","autoUpdateTimeStore"],services:["ajax","language","time","device","moduleManager"],views:["timeSettingsView"],deps:["main","utils"],listeners:{ev_on_launch:function(e,t,a,i,n,s,o){this.unRegisterAutoSaveData([i.time24Model]),o.time.on("on_time_change",t.onTimeChange),o.time.on("on_hour24_change",t.onHour24Change),n.languageStore.load({success:function(){var e=o.device.getLocale();t.unRegisterAutoSaveData([i.language]),i.language.language.setValue(e),i.language.language.record(),t.registerAutoSaveData([i.language])}}),i.time24Model.load(),i.timeSettings.load(),i.daylight.load()},ev_before_destroy:function(e,t){t.beforeDestroy()}},init:function(r,l,u,e,t,m){this.listen({"models.time24Model":{ev_loaded:function(e,t){m.time.setHour24("on"===u.time24Model.hour24Enable.getValue())},ev_model_submit:function(e,t){m.time.setHour24("on"===u.time24Model.hour24Enable.getValue())}},"models.daylight":{ev_loaded:function(e){"on"===u.daylight.dstEnable.getValue()||u.daylight.dstStatus.getValue()?u.daylight.dstStatus.show():u.daylight.dstStatus.hide(),r.getTimeFormat()}},"models.timeSettings":{ev_loaded:function(e,t){var a=t.date.split("/");r.sysTimeYear=parseInt(a[2],10),r.sysTimeHash=r.parseFormat(a[0],2)+r.parseFormat(a[1],2)+r.parseFormat(t.time.split(":")[0],2),r.getTimeFormat()}},"models.timeSettings.type":{ev_value_change:function(e,t,a){"manual"===t?(l.timeSettingsView.manualFieldset.show(),m.device.getConfig().supportSystemTimeAllTimeZone||(u.timeSettings.timezone.hide(),u.timeSettings.timezone.disable()),l.timeSettingsView.internetFieldset.hide(),u.timeSettings.time.enable(),u.timeSettings.date.enable()):"auto"===t?(l.timeSettingsView.manualFieldset.hide(),m.device.getConfig().supportSystemTimeAllTimeZone||(u.timeSettings.timezone.show(),u.timeSettings.timezone.enable()),l.timeSettingsView.internetFieldset.show(),u.timeSettings.time.disable(),u.timeSettings.date.disable()):(l.timeSettingsView.manualFieldset.hide(),m.device.getConfig().supportSystemTimeAllTimeZone||(u.timeSettings.timezone.hide(),u.timeSettings.timezone.disable()),l.timeSettingsView.internetFieldset.hide(),u.timeSettings.time.enable(),u.timeSettings.date.enable())}},"models.timeSettings.timezone":{ev_value_change:function(e,t,a){var i,n,s;null!==a&&(i=u.timeSettings.time.getValue().split(":"),s=parseInt(i[0],10),n=parseInt(i[1],10),n=(s=parseInt(60*s,10)+parseInt(n,10)+parseInt(t,10)-parseInt(a,10))%60,(a=24==(a=24<(t=parseInt(s/60,10))?t-24:t)&&0<n?0:a)<0&&(0==a?a=23:a+=24),n<0&&(n+=60),n<10&&(n="0"+n),s=(a=a<10?"0"+a:a).toString()+":"+n.toString()+":"+i[2],u.timeSettings.time.setValue(s))}},"models.time24Model.hour24Enable":{ev_value_change:function(e,t,a){a&&a!==t&&u.time24Model.submit()}},"models.daylight.dstEnable":{ev_value_change:function(e,t,a){"on"===t?l.timeSettingsView.daylightFieldset.show():l.timeSettingsView.daylightFieldset.hide()}},"models.daylight.startMonth":{ev_value_change:function(e,t,a){r.getTimeFormat()}},"models.daylight.startWeek":{ev_value_change:function(e,t,a){r.getTimeFormat()}},"models.daylight.startDay":{ev_value_change:function(e,t,a){r.getTimeFormat()}},"models.daylight.startHour":{ev_value_change:function(e,t,a){r.getTimeFormat()}},"models.daylight.endMonth":{ev_value_change:function(e,t,a){r.getTimeFormat()}},"models.daylight.endWeek":{ev_value_change:function(e,t,a){r.getTimeFormat()}},"models.daylight.endDay":{ev_value_change:function(e,t,a){r.getTimeFormat()}},"models.daylight.endHour":{ev_value_change:function(e,t,a){r.getTimeFormat()}}}),this.control({".index-common-save-btn":{ev_will_auto_save:function(e,t){t.preventDefault();var a,i,n,s=g.Deferred(),o=g.Deferred();u.timeSettings.isDirty()?("pc"===(t=u.timeSettings.type.getValue())?(i=(a=function(e){return e<10?"0"+e:e})((n=new Date).getMonth()+1)+"/"+a(n.getDate())+"/"+a(n.getFullYear()),n=a(n.getHours())+":"+a(n.getMinutes())+":"+a(n.getSeconds()),u.timeSettings.time.setValue(n),u.timeSettings.date.setValue(i),g.when(s).then(function(){m.time.sync()})):"auto"===t?(l.timeSettingsView.ntpStatus.hide(),g.when(s).then(function(){l.timeSettingsView.ntpStatus.show(),l.timeSettingsView.ntpStatus.setLoading(g.su.CHAR.TIMESETTING.GETGMT_WAIT),u.timeSettings.startGmt({success:function(){r.syncGmt(function(e){m.time.sync(),u.daylight.load()})},fail:function(){l.timeSettingsView.ntpStatus.hide()},error:function(){l.timeSettingsView.ntpStatus.hide()}})})):g.when(s).then(function(){m.time.sync()}),u.timeSettings.submit({success:function(){s.resolve()}})):s.resolve(),u.daylight.isDirty()?u.daylight.submit({success:function(){o.resolve()}}):o.resolve(),g.when(s,o).then(function(){u.language.language.isDirty()&&m.language.switchTo(u.language.language.getValue()),u.daylight.load()})}},"#setTimeMode":{ev_view_change:function(e,t,a){"on"==r.autoUpdateEnable&&"auto"!=a&&("pc"==a?l.timeSettingsView.setTimeCheckMsg.setContent(g.su.CHAR.FIRMWARE.SET_TIME_CHECK_NOTE1):"manual"==a&&l.timeSettingsView.setTimeCheckMsg.setContent(g.su.CHAR.FIRMWARE.SET_TIME_CHECK_NOTE2),l.timeSettingsView.setTimeCheckMsg.show())}},"#set-time-check-msg":{ev_msg_ok:function(e,t){t.preventDefault(),m.moduleManager.get("navigatorController").goTo("firmware")},ev_msg_no:function(e,t){u.timeSettings.type.setValue("auto")}}})}},function(v,T,y,a,t,i){var n=null;return{autoUpdateEnable:"",sysTimeYear:"2017",sysTimeHash:"",syncGmt:function(e){var t=function(t){i.ajax.request({proxy:"timeSettingsGmtProxy",method:"refresh",success:function(e){if("undefined"==typeof e.status)return T.timeSettingsView.ntpStatus.hide(),clearInterval(n),n=null,!1;switch(parseInt(e.status,10)){case 747301:clearInterval(n),n=null,T.timeSettingsView.ntpStatus.setSuccess(g.su.CHAR.TIMESETTING.GETGMT_SUCCESS),t&&t(e);break;case 747302:clearInterval(n),n=null,T.timeSettingsView.ntpStatus.setFailed(g.su.CHAR.TIMESETTING.GETGMT_TIMEOUT);break;case 747303:T.timeSettingsView.ntpStatus.setLoading(g.su.CHAR.TIMESETTING.GETGMT_WAIT);break;default:clearInterval(n),n=null}}})};clearInterval(n),n=setInterval(function(){t(e)},2e3),t(e)},onTimeChange:function(e,t){var a=i.time.getHour24(),t=i.time.format(t,"yyyy-MM-dd HH:mm:ss",a);T.timeSettingsView.currentTime.setValue(t)},onHour24Change:function(e,t){t?(a.startHourStore.loadData(v.startHour24Data),y.timeSettings.time.setHourSystem("24")):(a.startHourStore.loadData(v.startHourData),y.timeSettings.time.setHourSystem("12")),v.setAutoUpdateTimeStore()},clearCurrentTime:function(){clearInterval(n),n=null},beforeDestroy:function(){v.clearCurrentTime(),i.time.off("on_time_change",v.onTimeChange),i.time.off("on_hour24_change",v.onHour24Change)},startHourData:function(){for(var e,t=[],a=0;a<=23;a++)t[e=a]={},0===a?(t[e].name="12:00 AM",t[e].value="12am"):a<=11?(t[e].name=a+":00 AM",t[e].value=a+"am"):12===a?(t[e].name="12:00 PM",t[e].value="12pm"):(t[e].name=a-12+":00 PM",t[e].value=a-12+"pm");return t[0].selected=!0,t}(),startHour24Data:function(){for(var e,t=[],a=0;a<=23;a++)t[e=a]={},t[e].name=("0"+a).slice(-2)+":00",t[e].value=0===a?"12am":a<=11?a+"am":12===a?"12pm":a-12+"pm";return t[0].selected=!0,t}(),parseFormat:function(e,t){for(e=e.toString();e.length<t;)e="0"+e;return e},getTimeFormat:function(){var e=v.sysTimeYear,t=v.sysTimeHash,a=y.daylight.startMonth,i=y.daylight.startWeek,n=y.daylight.startDay,s=y.daylight.startHour,o=y.daylight.endMonth,r=y.daylight.endWeek,l=y.daylight.endDay,u=y.daylight.endHour,m=a.getValue(),g=i.getValue(),d=n.getValue(),s=s.getValue(),c=o.getValue(),S=r.getValue(),h=l.getValue(),u=u.getValue();if(!(m&&g&&d&&s&&c&&S&&h&&u))return!1;var f,m=parseInt(a.getLiIndex(m))+1,a=parseInt(i.getLiIndex(g))+1,g=parseInt(n.getLiIndex(d))+1,i=parseInt(o.getLiIndex(c))+1,d=parseInt(r.getLiIndex(S))+1,n=parseInt(l.getLiIndex(h))+1,c=-1!==s.indexOf("am")?(f=parseInt(s),parseInt(u)):(f=parseInt(s)+12,parseInt(u)+12),o=new Date(e,m,1),S=parseInt(o.getDay()),r=new Date(e,i,1),h=parseInt(r.getDay()),g=7*a-S+g+1+(g<S?7:0),n=7*d-h+n+1+(n<h?7:0),l=v.parseFormat(m,2)+v.parseFormat(g,2)+v.parseFormat(f,2),s=v.parseFormat(i,2)+v.parseFormat(n,2)+v.parseFormat(c,2),u=T.timeSettingsView.daylightStart,o=T.timeSettingsView.daylightEnd;l<s?t<s?(u.setSubLabel(e),o.setSubLabel(e)):(u.setSubLabel(e+1),o.setSubLabel(e+1)):t<s?(u.setSubLabel(e-1),o.setSubLabel(e)):(u.setSubLabel(e),o.setSubLabel(e+1))},setAutoUpdateTimeStore:function(){var e=t.utils.getAutoUpdateTimeStoreData();a.autoUpdateTimeStore.loadData(e)}}})}(jQuery);