!function(a){a.su.moduleManager.define("backupRestore",{models:["backupRestoreModel"],stores:[],services:["ajax","vtype"],deps:["main"],views:["backupRestoreView"],listeners:{ev_on_launch:function(e,r,t,o,s,i,c){t.backupRestoreView.factoryPanel.hide(),o.backupRestoreModel.load({success:function(e){e=o.backupRestoreModel.getData();r.restoreTime=parseInt(e.totalTime&&1e3*e.totalTime||r.restoreTime,10),r.factoryTime=parseInt(e.totalTime&&1e3*e.totalTime||r.factoryTime,10)}}),r.checkUser({success:function(e){1==a.su.userInfo.role?t.backupRestoreView.factoryPanel.hide():t.backupRestoreView.factoryPanel.show()}})}},init:function(o,s,e,r,t,i){this.configViews({}),this.listen({}),this.control({"#backup-button":{ev_button_click:function(){o.checkLan({success:function(){o.backup()}})}},"#restore-file":{ev_file_change:function(e,r){var r=o.checkFileName(r,"bin"),t=s.backupRestoreView.restoreFileModel;!0===r?t.setNormal():t.setError(r)}},"#restore-button":{ev_button_click:function(){o.checkLan({success:function(e){var r=s.backupRestoreView.restoreFileModel,t=s.backupRestoreView.restoreFileModel.getFileName(),t=o.checkFileName(t,"bin");!0===t?(r.setNormal(),s.backupRestoreView.restoreConfirmMsg.show()):r.setError(t)}})}},"#reset-button":{ev_button_click:function(){o.factoryType="partial",s.backupRestoreView.factoryConfirmMsg.show()}},"#factory-button":{ev_button_click:function(){o.factoryType="all",s.backupRestoreView.factoryConfirmMsg.show()}},"#restore-confirm-msg":{ev_msg_ok:function(){s.backupRestoreView.restoringTip.setText(a.su.CHAR.BACKUP_RESTORE.RESTORING),s.backupRestoreView.restoringMsg.show(),o.restoreFromFile()}},"#factory-confirm-msg":{ev_msg_ok:function(){s.backupRestoreView.restoringTip.setText(a.su.CHAR.BACKUP_RESTORE.RESTORING),s.backupRestoreView.restoringMsg.show(),o.factoryRestore()}}})}},function(r,o,e,t,s,i){return{restoreTime:12e4,factoryTime:12e4,factoryType:"all",restoreTimeout:!1,factoryTimeout:!1,restoreProgressTimeout:!1,factoryProgressTimeout:!1,backup:function(){i.ajax.upload({proxy:"backupProxy",fileId:"backup-file"})},checkUser:function(e){var r;e&&(r=e.success),i.ajax.request({proxy:"getDeviceInfoProxy",success:function(e){r&&r(e)}})},restoreFromFile:function(){o.backupRestoreView.restoreProbar.reset(),i.ajax.upload({proxy:"uploadRestoreFileProxy",fileId:"restore-file",timeout:72e4,success:function(e){clearTimeout(r.restoreTimeout),r.restoreTimeout=setTimeout(r.checkRestoreResult,1e3),r.restoreProgressTimeout&&(clearTimeout(r.restoreProgressTimeout),r.restoreProgressTimeout=!1),r.restoreProgressTimeout=setTimeout(function(){r.restoreAnimate(r.restoreTime)},1200)},fail:function(){clearTimeout(r.restoreTimeout),r.checkRestoreResult()},error:function(){o.backupRestoreView.restoringMsg.hide()}})},checkRestoreResult:function(){r.checkLan({success:function(){},fail:function(e){r.restoreTimeout&&(clearTimeout(r.restoreTimeout),r.restoreTimeout=!1),r.restoreProgressTimeout&&(clearTimeout(r.restoreProgressTimeout),r.restoreProgressTimeout=!1),o.backupRestoreView.restoringMsg.hide(),r.showErr(e.errorcode,"restore")},error:function(){o.backupRestoreView.restoringMsg.hide()}})},factoryRestore:function(){o.backupRestoreView.restoreProbar.reset(),i.ajax.request({proxy:"factoryRestoreProxy",method:"all"===this.factoryType?"factoryRestore":"resetRestore",success:function(e){r.restoreAnimate(r.factoryTime)},fail:function(){r.checkFactoryResult()},error:function(){o.backupRestoreView.restoringMsg.hide()}})},checkFactoryResult:function(){r.checkLan({success:function(){},fail:function(e){r.factoryTimeout&&(clearTimeout(r.factoryTimeout),r.factoryTimeout=!1),r.factoryProgressTimeout&&(clearTimeout(r.factoryProgressTimeout),r.factoryProgressTimeout=!1),o.backupRestoreView.restoringMsg.hide(),r.showErr(e.errorcode,"factory")},error:function(){o.backupRestoreView.restoringMsg.hide()}})},restoreAnimate:function(e){o.backupRestoreView.restoringTip.setText(a.su.CHAR.BACKUP_RESTORE.RESTORING),o.backupRestoreView.restoringMsg.show(),o.backupRestoreView.restoreProbar.reset(),o.backupRestoreView.restoreProbar.animate({percentageStart:0,percentageEnd:100,duration:e,callback:function(){o.backupRestoreView.restoringMsg.hide(),localStorage&&localStorage.setItem("token",""),location.href="http://tplinkwifi.net"}})},checkFileName:function(e,r){return i.vtype.validate(e,{vtype:"string_file",extension:r})},checkLan:function(e){var r,t,o;e&&(r=e.success,t=e.fail,o=e.error),i.ajax.request({proxy:"checkLanProxy",success:function(e){r&&r(e)},fail:function(e){t&&t(e)},error:function(e){o&&o(e)}})},showErr:function(e,r){var t="";switch(r=r||"restore",e){case"err_form":t=a.su.CHAR.ERROR["00000001"];break;case"err_check":t=a.su.CHAR.ERROR["00000002"];break;case"err_sizex":t=a.su.CHAR.ERROR["00000003"];break;case"err_flash":t=a.su.CHAR.ERROR["00000004"];break;case"err_reboot":t=a.su.CHAR.ERROR["00000005"];break;case"err_other":t=a.su.CHAR.ERROR["00000006"];break;case"err_failed":t=a.su.CHAR.ERROR["00000136"];break;default:t=""}o.backupRestoreView.restoreFailAlert.hide(),o.backupRestoreView.factoryFailAlert.hide(),t&&("restore"===r?(o.backupRestoreView.restoreFailAlert.setContent(t),o.backupRestoreView.restoreFailAlert):(o.backupRestoreView.factoryFailAlert.setContent(t),o.backupRestoreView.factoryFailAlert)).show()}}})}(jQuery);