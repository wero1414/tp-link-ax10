!function(c){c.su.moduleManager.define("cloud",{deps:[],services:["ajax","device"],models:[],stores:[],views:["cloudTPLinkIdView","cloudIframeView"],listeners:{ev_on_launch:function(e,n,t,o,i,a,s){var u,n=this,r=this;c.su=c.su||{},c.su.Message=((u=function(e){this.id=e.id||parseInt(1e3*Math.random()*1e3*1e3,10),this.ack=e.ack||null,this.type=e.type,this.name=e.name,this.data=e.data}).prototype.getId=function(){return this.id},u.prototype.setAck=function(e){this.ack=e},u.prototype.getAck=function(){return this.ack},u.prototype.getType=function(){return this.type},u.prototype.getName=function(){return this.name},u.prototype.setData=function(e){this.data=e},u.prototype.getData=function(){return this.data},u),c.su.Request=((u=function(e){this.readyState=0,this.timeout=1e4,this.timeoutId=null,this.timeoutFlag=!1;e=new c.su.Message(e);this.requestContent=e,this.responseContent=null,this.onload=null,this.onerror=null,this.ontimeout=null}).prototype.send=function(){var e=this,t=this.requestContent,t=JSON.stringify(t);e.timeoutFlag=!1,window.parent.postMessage(t,c.origin),e.timeoutId=setTimeout(function(){e.timeoutFlag=!0,e.ontimeout&&e.ontimeout()},e.timeout)},u.prototype.responseHandler=function(){var e=this.responseContent;clearInterval(this.timeoutId),this.timeoutFlag=!1,this.onload&&"function"==typeof this.onload&&this.onload(e)},u),c.su.RequestManager={requests:{},handler:{},addRequest:function(e){var t=e.requestContent.getId();this.requests[t]=e},removeRequest:function(e){e=e.requestContent.getId();delete this.requests[e]},getRequestByAck:function(e){return this.requests[e]},addHandler:function(e,t){this.handler[e]=t},onMessage:function(){var s=this;c(window).on("message",function(e){var t;if("string"!=typeof(t=e.originalEvent||e).data)throw"Error! Data is not a string.";try{var n=c.parseJSON(t.data)}catch(t){throw"Error! String can not be parsed."}var o,i=(e=new c.su.Message(n)).getType(),a=e.getAck();"message"==i?(o=e.getName(),n=e.getData(),s.handler[o](n)):a?((i=c.su.RequestManager.getRequestByAck(a)).responseContent=e,i.timeoutFlag||(i.responseHandler(),c.su.RequestManager.removeRequest(i))):(o=e.getName())&&(n.data=n.data||{},s.handler[o](n.data),n.ack=n.id,a=JSON.stringify(n),window.frames["cloud-login"].postMessage(a,r.cloudOrigin))})}},c.su.RequestManager.onMessage(),c.su.RequestManager.addHandler("load",function(e){e.locale=s.device.getLocale(),e.force=s.device.getForce(),e.model=s.device.getProductName(),e.cloudOrigin=n.cloudOrigin,e.token=n.token;var t=n.getDeviceInfo();c.extend(e,t),n.clearWaitingEvent()}),c.su.RequestManager.addHandler("ev_mouseWheel",function(e){}),c.su.RequestManager.addHandler("ev_mouseClick",function(e){}),n.getToken("devicePages&page=account"),this.control({"#cloud-iframe-widget":{load:function(){}}})}},init:function(e,t,n,o,i,a){}},function(i,a,e,t,n,s){i=this;return{getToken:function(e,t,n){n=!1===n?c.su.url("/login?form=get_token"):c.su.url("/admin/cloud_account?form=get_token");!i.token||t?i.tokenRead(e,0,n):a.cloudIframeView.cloudIframe.setIframeSrc(e)},tokenRead:function(t,n,o){s.ajax.request({url:o,success:function(e){i.token=e.token,!i.token&&++n<3?i.tokenRead(t,n,o):i.token?(i.cloudOrigin=e.origin_url,a.cloudIframeView.cloudIframe.setCloudOrigin(e.origin_url),a.cloudIframeView.cloudIframe.setIframeSrc(t)):c(window).trigger("ev_watingTimeout")}})},postToken:function(){var e={};e.token=i.token,c.su.Cloud.send({type:"message",name:"ev_token",data:e})},getDeviceInfo:function(e){var t;return i.deviceInfo=i.deviceInfo||{},i.deviceInfo.cloudUserName?(t={},t=i.deviceInfo):(e=!1===e?c.su.url("/login?form=get_deviceInfo"):c.su.url("/admin/cloud_account?form=get_deviceInfo"),s.ajax.request({ajax:{"async":!1},url:e,success:function(e){i.deviceInfo=e.data,t=i.deviceInfo}}),t)},clearWaitingEvent:function(){}}})}(jQuery);