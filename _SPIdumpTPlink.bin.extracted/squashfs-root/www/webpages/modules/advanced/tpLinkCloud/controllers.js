!function(u){u.su.moduleManager.define("tpLinkCloud",{deps:["main","index"],services:["moduleLoader","ajax","device","moduleManager"],models:["cloudLogin","cloudLoginControl"],stores:[],views:["tpLinkCloudView","tpLinkCloudViewQs"],listeners:{ev_on_launch:function(e,o,n,i,t,r,s){this.init()}},init:function(e,o,n,i,t,r){}},function(r,s,e,o,i,a){var n=null;r.getEffectiveView();return{init:function(){var o=this,n=o.getEffectiveView();u("#cloud-login").hide(),s[n].cloudErrorLoader.hide(),u(window).off("ev_watingTimeout"),u(window).on("ev_watingTimeout",function(){i.main.clearWaitingEvent(),i.index.hideLoading(),a.moduleLoader.load({module:"tpLinkCloud"},{module:"cloudError"},s[n].cloudErrorLoader,function(){a.moduleManager.get("cloudError").setMode("qs")}),s[n].cloudErrorLoader.show()}),s[n].tpLinkCloudMainPanel.hide(),s[n].tpLinkCloudNoteField.hide(),u.su.userInfo.token?a.ajax.request({proxy:"checkInternetProxy",success:function(e){s[n].tpLinkCloudNoteField.hide(),s[n].tpLinkCloudMainPanel.show(),s[n].tpLinkCloudMainPanel.setInstruction(""),o.goTo("devicePages&page=account")},fail:function(){s[n].tpLinkCloudMainPanel.hide(),s[n].tpLinkCloudNoteField.show()}}):a.ajax.request({proxy:"checkInternetProxy",success:function(e){s[n].tpLinkCloudNoteField.hide(),s[n].tpLinkCloudMainPanel.show(),s[n].tpLinkCloudMainPanel.setInstruction(u.su.CHAR.TP_LINK_CLOUD.INSTRUCTION),"qs"===o.getMode()?o.goTo("login&page=spfQsLogin"):o.goTo("login&page=spfBasicLogin")},fail:function(){s[n].tpLinkCloudMainPanel.hide(),s[n].tpLinkCloudNoteField.show()}}),u(window).off("message"),u(window).on("message",o.onReceive)},setMode:function(e){n=e},getMode:function(){return n},setIframeSrc:function(e){var o;e&&(o=new Date,e=r.cloudOrigin+"/cloud_ui_v2/pages/device/index.html?module="+e+"&t="+o.getTime(),u("#cloud-login").hide(),u("#cloud-login").attr("src",e),i.main.setWaitingEvent("ev_watingTimeout"))},tokenRead:function(o,n){a.ajax.request({proxy:"tokenProxyIndex",ajax:{"async":!1},method:"read",success:function(e){r.token=e.token,!r.token&&++n<3?r.tokenRead(o,n):r.token?(r.cloudOrigin=e.origin_url,r.setIframeSrc(o)):(u(window).trigger("ev_watingTimeout"),i.index.hideLoading())}})},getToken:function(e){r.token?r.setIframeSrc(e):r.tokenRead(e,0)},postToken:function(){var e={},e=(e.deviceToken=r.token,e.eType="ev_token",JSON.stringify(e));window.frames["cloud-login"]&&window.frames["cloud-login"].postMessage(e,r.cloudOrigin)},postUserInfo:function(){var e={},e=((e=u.su.userInfo).eType="ev_user_info",JSON.stringify(e));window.frames["cloud-login"]&&window.frames["cloud-login"].postMessage(e,r.cloudOrigin)},postRgSec:function(){var e={},e={RG_SEC:u.su.IS_RG_SEC,eType:"ev_rg_sec"},e=JSON.stringify(e);window.frames["cloud-login"]&&window.frames["cloud-login"].postMessage(e,r.cloudOrigin)},postLoginStatus:function(){var e={eType:"ev_login_status"},e=JSON.stringify(e);window.frames["cloud-login"]&&window.frames["cloud-login"].postMessage(e,r.cloudOrigin)},getDeviceInfo:function(){a.ajax.request({proxy:"deviceInfoProxyIndex",method:"read",success:function(e){var o={},e=((o=e).gamingUI=a.device.getConfig().supportGamingUIGX90,o.updateLoginStatus=!0,o.eType="ev_deviceInfo",JSON.stringify(o));window.frames["cloud-login"].postMessage(e,r.cloudOrigin)}})},goTo:function(e){e&&(i.index.showLoading(),r.getToken(e))},doCloudLogin:function(e){var e={operation:e,token:u.su.userInfo.token},o=r.getMode();a.ajax.request({proxy:"userLoginProxy",data:e,success:function(e){u.su.userInfo.role=e.role,localStorage.setItem("userInfo",u.su.DES3.encrypt(JSON.stringify(u.su.userInfo))),r.postLoginStatus(),"qs"==o?i.main.reload():(i.index.changeTPLinkID(u.su.userInfo.username),r.goTo("devicePages&page=account"))},fail:function(e,o,n){u.su.userInfo={},r.postLoginStatus();var i,e=e.data.errorcode;(e=e&&String(e).replace(/^-/,"E"))&&-1!=u.su.cloudErrorCode.indexOf(e)&&(i=r.getEffectiveView(),s[i].cloudErrorPromptContent.setText(u.su.CHAR.ERROR[e]),s[i].cloudErrorPrompt.show())},error:r.postLoginStatus})},onReceive:function(e){e=e.originalEvent||e;if(e.origin===r.cloudOrigin||"_self"===e.origin||e.origin==undefined){var o=e.data,t=("string"==typeof e.data&&(o=u.parseJSON(o)),r.getEffectiveView());if(o)switch(o.eType){case"ev_goto":if("login"==o.url||"login"==o.index)return void("qs"===r.getMode()&&(s[t].tpLinkCloudInfoPanel.show(),u("#cloud-login").removeClass("qs"),a.moduleManager.get("qsCloudAndTether").showCloudEle()));o.url&&r.getToken(o.url);break;case"load":var n={},n=(n.locale=a.device.getLocale(),n.force=a.device.getForce(),n.model=a.device.getProductName(),n.eType="ev_init",JSON.stringify(n));window.frames["cloud-login"]&&window.frames["cloud-login"].postMessage(n,r.cloudOrigin),i.main.clearWaitingEvent(),i.index.hideLoading(),u("#cloud-login").show(),u.su.userInfo.token&&r.postUserInfo(),r.postRgSec(),r.postToken(),r.getDeviceInfo();break;case"ev_unbind":a.ajax.request({proxy:"cloudUnbindProxy",method:"write",data:{token:u.su.userInfo.token,role:u.su.userInfo.role},success:function(e){a.ajax.request({proxy:"cloudLogoutProxy",method:"write",success:function(){localStorage&&localStorage.setItem("token",""),location.href="/"}})},fail:function(e,o,n){var i=o;o&&(i=String(o).replace(/^-/,"E"),o=u.su.CHAR.ERROR[i],"E5001"==i&&(o=u.su.CHAR.ERROR[i].replace("%email",e.data.ownerAccount)),s[t].cloudErrorPromptContent.setText(o),s[t].cloudErrorPrompt.show())}});break;case"ev_mouseWheel":n=u(".page-content").scrollTop();u(".page-content").scrollTop(n-o.delta);break;case"ev_login":o.validate&&(u.su.userInfo.username=o.email,u.su.userInfo.token=o.token,a.ajax.request({proxy:"cloudBindStatusProxy",method:"read",data:{token:u.su.userInfo.token},success:function(e){e.isbind?r.doCloudLogin("login"):r.doCloudLogin("bind")},fail:r.postLoginStatus,error:r.postLoginStatus}));break;case"ev_logout":case"ev_changePwd":a.ajax.request({proxy:"cloudLogoutProxy",method:"write",success:function(){localStorage&&localStorage.setItem("token",""),location.href="/"}});break;case"ev_qs_switch":s[t].tpLinkCloudInfoPanel.hide(),u("#cloud-login").addClass("qs"),a.moduleManager.get("qsCloudAndTether").hideCloudEle()}}}}})}(jQuery);