!function(s){s.su.moduleManager.define("accessControl",{models:["accessControl","addAccessControl","accessControlEnableM"],stores:["accessModeStore","blacklistGridStore","whitelistGridStore","addDeviceStore","onlineDeviceStore","portForwardingConnectedDevicesStore"],services:["ajax"],views:["accessControlView"],listeners:{ev_on_launch:function(e,t,n,o,c,a,i){c.portForwardingConnectedDevicesStore.load(),o.accessControl.load(),o.accessControlEnableM.load()}},init:function(o,c,a,i,e,n){var t={minLines:0,paging:{},columns:[{text:s.su.CHAR.ACCESS_CONTROL.DEVICE_NAME,dataIndex:"name",cls:"xl-hide l-hide"},{text:s.su.CHAR.ACCESS_CONTROL.DEVICE_TYPE,dataIndex:"deviceType",cls:"icon40 access-control-icon40",renderer:function(e,t){var n="";return(n+='<div class="device-type-container widget-container">')+('<span class="icon icon-'+(e=(e=e!==undefined&&null!==e?e:"pc").toLowerCase())+("HOST"===t.host?" host":"")+' "></span>')+"</div>"}},{text:s.su.CHAR.ACCESS_CONTROL.DEVICE_NAME,dataIndex:"name",cls:"s-hide m-hide"},{text:s.su.CHAR.ACCESS_CONTROL.MAC_ADDRESS,dataIndex:"mac"},{xtype:"actioncolumn",text:s.su.CHAR.ACCESS_CONTROL.MODIFY,renderer:function(e,t){t='<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-delete btn-delete '+("HOST"===t.host?"disabled":"")+'">';return(t+='<span class="icon"></span>')+'<span class="text"></span>'+"</a>"}}]};this.configViews({id:"accessControlView",items:[{id:"grid-blacklist",configs:t},{id:"grid-whitelist",configs:t},{id:"grid-online-device",host:{name:"host",setted:!0},configs:[{type:"logo",dataIndex:"deviceType"},{type:"deviceName",dataIndex:"name"},{type:"mac",dataIndex:"mac"},{type:"ip",dataIndex:"ipaddr"}]}]});this.control({"#access-control-enable":{ev_view_change:function(e,t){a.accessControlEnableM.submit({success:function(){a.accessControl.load()}})}},"#grid-blacklist":{ev_grid_tbar_add:o.onBeforeAdd},"#grid-whitelist":{ev_grid_tbar_add:o.onBeforeAdd},"#add-device-msg":{ev_msg_ok:function(e,t){var n=a.addAccessControl.addDeviceMethod.getValue();0===n?o.handleSelectFromList(t):1===n&&o.handleAddManually(t)}},".index-common-save-btn":{ev_will_auto_save:function(e,t){t.preventDefault();t={operation:"write"};t["access_mode"]=a.accessControl.accessMode.getValue(),n.ajax.request({url:s.su.url("/admin/access_control?form=mode"),data:t,success:function(e){a.accessControl.load()}})}}}),this.listen({"models.accessControlEnableM.enable":{ev_value_change:function(e,t){"off"===t?c.accessControlView.accessControlContent.hide():c.accessControlView.accessControlContent.show()}},"models.accessControl.accessMode":{ev_value_change:function(e,t){o.loadListStore(function(){o.isBlacklistMode()?(i.blacklistGridStore.show(),i.whitelistGridStore.hide(),i.onlineDeviceStore.setMultiSelect(!0)):(i.blacklistGridStore.hide(),i.whitelistGridStore.show(),i.onlineDeviceStore.setMultiSelect(!1))})}},"models.addAccessControl.addDeviceMethod":{ev_value_change:function(e,t,n){var o;0===t?(o=i.onlineDeviceStore.getData(),i.onlineDeviceStore.show(),a.addAccessControl.newMac.hide(),a.addAccessControl.name.hide(),0===o.length||1===o.length&&"HOST"===o[0].host?c.accessControlView.addDeviceMsg.disableButton("ok"):c.accessControlView.addDeviceMsg.enableButton("ok")):1===t&&(i.onlineDeviceStore.hide(),a.addAccessControl.newMac.show(),a.addAccessControl.name.show(),c.accessControlView.addDeviceMsg.enableButton("ok"))}}})}},function(c,e,o,a,t,i){return{isBlacklistMode:function(){return"black"===o.accessControl.accessMode.getValue()},isHostDevice:function(t){return!!a.onlineDeviceStore.getData().find(function(e){return e.mac===t&&"HOST"==e.host})},hasSameMac:function(t){return!!(c.isBlacklistMode()?a.blacklistGridStore:a.whitelistGridStore).getData().find(function(e){return e.mac===t})},initDeviceStore:function(){return c.loadOnlineDevices().then(function(e){e=c.convertDeviceStore(e);return a.onlineDeviceStore.loadData(e,!0,{},function(e){for(var t=0;t<e.length;t++)"HOST"==e[t].host&&a.onlineDeviceStore.disable(e[t].key)}),e})},loadOnlineDevices:function(){var t=s.Deferred(),e=c.isBlacklistMode()?"blackDeviceProxy":"whiteDeviceProxy";return i.ajax.request({proxy:e,method:"read",success:function(e){t.resolve(e)}}),t.promise()},loadListStore:function(t){var n=c.isBlacklistMode()?a.blacklistGridStore:a.whitelistGridStore;n.load({success:function(e){n.loadData(c.convertDeviceStore(e)),t&&t()}})},convertDeviceStore:function(e){var n;return s.isArray(e)?(n=a.portForwardingConnectedDevicesStore.getData(),e.slice().map(function(t){var e=n.find(function(e){return t.mac===e.mac});return e&&(t.deviceType=e.deviceType),t})):[]},handleSelectFromList:function(e){var t=a.onlineDeviceStore.getSelected();if(0===t.length)return e.preventDefault();c.addDevice(t)},handleAddManually:function(e){var t,n;return o.accessControl.validate()?(t=o.addAccessControl.newMac.getValue(),n=o.addAccessControl.name.getValue(),c.hasSameMac(t)?(o.addAccessControl.newMac.setError(s.su.CHAR.ERROR["00000051"]),e.preventDefault()):c.isHostDevice(t)?(o.addAccessControl.newMac.setError(s.su.CHAR.ERROR["00000064"]),e.preventDefault()):void c.addDevice([{name:n,mac:t}])):e.preventDefault()},addDevice:function(e){var t={},n=e.length,o=c.isBlacklistMode()?"/admin/access_control?form=black_list":"/admin/access_control?form=white_list";1===n?(t["operation"]="insert",t["key"]="add",t["old"]="add",t["index"]=0,t["new"]=JSON.stringify(e[0])):(t["data"]=JSON.stringify(e),t["operation"]="block",t["index"]=n-1,t["key"]=e[n-1].key,o="/admin/access_control?form=black_devices"),i.ajax.request({data:t,url:s.su.url(o),success:function(){c.loadListStore()}})},onBeforeAdd:function(){c.initDeviceStore().then(function(){o.addAccessControl.reset(),e.accessControlView.addDeviceMsg.show()})}}})}(jQuery);