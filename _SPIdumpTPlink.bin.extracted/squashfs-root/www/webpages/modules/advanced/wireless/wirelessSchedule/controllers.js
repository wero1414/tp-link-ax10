!function(d){d.su.moduleManager.define("wirelessSchedule",{deps:["navigatorController"],services:["ajax","time","device"],models:["wirelessSchedule","timeSettings"],stores:["scheduleStore","hourComboStore","minuteComboStore","ampmComboStore","wirelessOffStore"],views:["wirelessScheduleView"],listeners:{ev_on_launch:function(e,t,s,i,n,r,a){s.wirelessScheduleView.wirelessScheduleEnableCfg.hide(),i.wirelessSchedule.load({success:function(e){i.timeSettings.load({success:function(e){"auto"==e.type?i.wirelessSchedule.enable.enable():i.wirelessSchedule.enable.disable()}})}})},ev_before_destroy:function(e,t){t.clearUpdateTime()}},init:function(i,n,s,r,e,a){this.configViews({id:"wirelessScheduleView",items:[{id:"grid-schedule",configs:{tbar:{add:{text:d.su.CHAR.OPERATION.ADD,index:0}},popEditor:{addTitle:d.su.CHAR.WIRELESS_SCHEDULE.ADD_SCHEDULE,editTitle:d.su.CHAR.WIRELESS_SCHEDULE.MODIFY_SCHEDULE,content:"#grid-schedule-editor",fields:[{name:"timeFrom"},{name:"timeTo"},{name:"repeat"}]},columns:[{text:d.su.CHAR.WIRELESS_SCHEDULE.WIRELESS_OFF_TIME,dataIndex:"time",renderer:function(e){var t,s;if(e)return s=e.split("-")[0],e=e.split("-")[1],t="",0==parseInt(s.split(":")[0],10)?t+="12 "+d.su.CHAR.WIRELESS_SCHEDULE.AM:parseInt(s.split(":")[0],10)<12?t+=s+" "+d.su.CHAR.WIRELESS_SCHEDULE.AM:12==parseInt(s.split(":")[0],10)?t+="12 "+d.su.CHAR.WIRELESS_SCHEDULE.PM:t+=parseInt(s.split(":")[0],10)-12+" "+d.su.CHAR.WIRELESS_SCHEDULE.PM,t+="-",0==parseInt(e.split(":")[0],10)?t+="12 "+d.su.CHAR.WIRELESS_SCHEDULE.AM:parseInt(e.split(":")[0],10)<12?t+=e+" "+d.su.CHAR.WIRELESS_SCHEDULE.AM:12==parseInt(e.split(":")[0],10)?t+="12 "+d.su.CHAR.WIRELESS_SCHEDULE.PM:t+=parseInt(e.split(":")[0],10)-12+" "+d.su.CHAR.WIRELESS_SCHEDULE.PM,s=parseInt(s.split(":")[0],10),parseInt(e.split(":")[0],10)<=s&&(t+=" ("+d.su.CHAR.WIRELESS_SCHEDULE.NEXT_DAY+")"),t}},{text:d.su.CHAR.WIRELESS_SCHEDULE.REPEAT,dataIndex:"repeat",renderer:function(e){var t=e.split(",");if("eve"==t[0])return d.su.CHAR.WIRELESS_SCHEDULE.EVE;if("weekdays"==t[0])return d.su.CHAR.WIRELESS_SCHEDULE.WEEKDAYS;if("weekends"==t[0])return d.su.CHAR.WIRELESS_SCHEDULE.WEEKENDS;for(var s="",i=0;i<t.length;i++){switch(t[i]){case"sun":s+=d.su.CHAR.WIRELESS_SCHEDULE.SUN;break;case"mon":s+=d.su.CHAR.WIRELESS_SCHEDULE.MON;break;case"tue":s+=d.su.CHAR.WIRELESS_SCHEDULE.TUES;break;case"wed":s+=d.su.CHAR.WIRELESS_SCHEDULE.WED;break;case"thu":s+=d.su.CHAR.WIRELESS_SCHEDULE.THUR;break;case"fri":s+=d.su.CHAR.WIRELESS_SCHEDULE.FRI;break;case"sat":s+=d.su.CHAR.WIRELESS_SCHEDULE.SAT}i!=t.length-1&&(s+=",")}return s}},{xtype:"actioncolumn",text:d.su.CHAR.WIRELESS_SCHEDULE.MODIFY,renderer:function(e,t){var s='<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-edit btn-edit">';s+='<span class="icon"></span>';return'<a href="javascript:void(0)" class="grid-content-btn grid-content-btn-edit btn-edit"><span class="icon"></span><span class="text"></span></a><a href="javascript:void(0)" class="grid-content-btn grid-content-btn-delete btn-delete"><span class="icon"></span><span class="text"></span></a>'}}]}}]}),this.control({".index-common-save-btn":{ev_will_auto_save:function(e,t){t.preventDefault(),i.setOperation(i.OPERATION.SAVE),"on"==s.wirelessSchedule.enable.getValue()&&i.hasScheduleConflict()?n.wirelessScheduleView.wirelessOffMsg.show():i.submit()}},"#wireless-off-msg":{ev_msg_ok:function(){i.submit({next_time:n.wirelessScheduleView.wirelessOffTime.getValue()})},ev_msg_close:i.loadScheduleStore,ev_msg_cancel:i.loadScheduleStore},"#grid-schedule":{ev_grid_before_edit:function(e,t,s){i.setOperation(i.OPERATION.ADD_OR_EDIT)},ev_grid_before_item_delete:function(e,t,s){i.setOperation(i.OPERATION.DELETE)}},"#wireless-schedule-note => #go-to-time-settings":{click:function(){e.navigatorController.goTo("timeSettings")}}}),this.listen({"models.wirelessSchedule.enable":{ev_value_change:function(e,t,s){i.setOperation(i.OPERATION.ENABLE),"on"==t?(i.loadScheduleStore(),n.wirelessScheduleView.wirelessScheduleEnableCfg.show(),a.time.on("on_time_change",i.onTimeChange),a.time.on("on_hour24_change",i.onHour24Change)):(n.wirelessScheduleView.wirelessScheduleEnableCfg.hide(),a.time.off("on_time_change",i.onTimeChange),a.time.off("on_hour24_change",i.onHour24Change))}},"stores.scheduleStore":{ev_data_change:function(e,t,s){t.value!=t.oldValue&&"enable"==s.getName()&&r.scheduleStore.sync()},ev_before_sync:function(e,t,s){t.preventDefault(),i.isEditing()&&i.hasScheduleConflict(i.getEditingId())?n.wirelessScheduleView.wirelessOffMsg.show():i.submit()},ev_before_add:function(e,t){i.setEditingId(t.key.getValue())}},"views.wirelessScheduleView.timeFrom":{ev_value_change:function(e,t){var s=n.wirelessScheduleView.timeTo.getValue();"string"==typeof t&&"string"==typeof s&&(t=parseInt(t.split(":")[0],10),parseInt(s.split(":")[0],10)<=t?n.wirelessScheduleView.timeTo.setShortTips(d.su.CHAR.WIRELESS_SCHEDULE.NEXT_DAY_TIP):n.wirelessScheduleView.timeTo.setShortTips(""))}},"views.wirelessScheduleView.timeTo":{ev_value_change:function(e,t){var s=n.wirelessScheduleView.timeFrom.getValue();"string"==typeof s&&"string"==typeof t&&(s=parseInt(s.split(":")[0],10),parseInt(t.split(":")[0],10)<=s?n.wirelessScheduleView.timeTo.setShortTips(d.su.CHAR.WIRELESS_SCHEDULE.NEXT_DAY_TIP):n.wirelessScheduleView.timeTo.setShortTips(""))}}})}},function(n,i,t,r,e,a){var s="",o="",u=["sun","mon","tue","wed","thu","fri","sat"],l=["mon","tue","wed","thu","fri"],c=["sun","sat"];return{OPERATION:{SAVE:"save",ENABLE:"enable",DELETE:"delete",ADD_OR_EDIT:"add_or_edit"},onTimeChange:function(e,t){var s=a.time.getHour24(),t=a.time.format(t,"yyyy-MM-dd HH:mm:ss",s);i.wirelessScheduleView.currentTime.setValue(t)},onHour24Change:function(e,t){t?(i.wirelessScheduleView.timeFrom.setHourSystem("24"),i.wirelessScheduleView.timeTo.setHourSystem("24")):(i.wirelessScheduleView.timeFrom.setHourSystem("12"),i.wirelessScheduleView.timeTo.setHourSystem("12"))},clearUpdateTime:function(){a.time.off("on_time_change",n.onTimeChange),a.time.off("on_hour24_change",n.onHour24Change)},isCurrentDayIncluded:function(e,t){e=e.repeat,t=u[t.getDay()];return"eve"==e||-1<e.indexOf(t)||"weekdays"==e&&l.includes(t)||"weekends"==e&&c.includes(t)},isCurrentTimeIncluded:function(e,t){var s=parseInt(e.timeFrom),e=parseInt(e.timeTo),i=t.getHours();return e===i&&0<t.getMinutes()&&(i+=1),n.hasNextDay(s,e)?s<=i||i<=e:s<=i&&i<=e},hasNextDay:function(e,t){return t<=e},hasScheduleConflict:function(e){var s=a.time.getTime(),i=!1,t=[];return e?t.push(r.scheduleStore.getModelByKey(e).getData()):t=r.scheduleStore.getData(),t.length&&d.each(t,function(e,t){return!(i=n.isCurrentDayIncluded(t,s)&&n.isCurrentTimeIncluded(t,s))}),i},loadScheduleStore:function(){s!=n.OPERATION.SAVE&&a.ajax.request({proxy:"wirelessScheduleAddListProxy",method:"read",success:function(e){r.scheduleStore.loadData(e.data,!0)}})},setOperation:function(e){s=e},isEditing:function(){return s==n.OPERATION.ADD_OR_EDIT},setEditingId:function(e){o=e},getEditingId:function(){return o},submit:function(e){switch(s){case n.OPERATION.SAVE:n.submitEnableModel(e||{});break;case n.OPERATION.ADD_OR_EDIT:case n.OPERATION.DELETE:n.submitScheduleStore(e||{})}},submitEnableModel:function(e){t.wirelessSchedule.nextTime.setValue(e.next_time),t.wirelessSchedule.submit()},submitScheduleStore:function(e){e={list:n.formatRepeat(),next_time:e.next_time},a.ajax.request({proxy:"wirelessScheduleAddListProxy",method:"write",data:e,success:function(e){r.scheduleStore.loadData(e.data,!0)}})},formatRepeat:function(){for(var e=r.scheduleStore.getStoreData(),t=[],s=0;s<e.length;s++){var i=e[s].repeat;switch(i){case"weekends":i=c.join(",");break;case"weekdays":i=l.join(",");break;case"eve":i=u.join(",")}t.push(i+":["+parseInt(e[s].timeFrom)+","+parseInt(e[s].timeTo)+"]")}return JSON.stringify(t)}}})}(jQuery);