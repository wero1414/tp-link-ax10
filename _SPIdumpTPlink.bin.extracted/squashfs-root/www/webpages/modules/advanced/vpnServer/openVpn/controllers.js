!function(d){d.su.moduleManager.define("openVpn",{services:["ajax","device"],stores:["serviceTypeStore","accessStore","wanStore","dhcpAddressList"],models:["openVpnModel","lanAdvWanModel","pptpVpnModel","dhcpServer","l2tpIpsecModel"],views:["openVpnView"],deps:["utils"],listeners:{ev_on_launch:function(e,n,t,r,p,a,s){"ios"===d.su.platform&&t.openVpnView.configurationFilePanel.hide(),n.operateMode="",n.certExist=!1,n.certGenerateResult=!1,n.pptpvpnIpStart="",n.pptpvpnIpEnd="",n.l2tpvpnIpStart="",n.l2tpvpnIpEnd="",n.dhcpIpStart="",n.dhcpIpEnd="",n.dhcpReservation="",r.openVpnModel.load(),r.pptpVpnModel.load({success:function(e){var t=r.pptpVpnModel.getData().remoteip;n.pptpvpnIpStart=t.substr(0,t.indexOf("-")),n.pptpvpnIpEnd=n.pptpvpnIpStart.substr(0,n.pptpvpnIpStart.lastIndexOf(".")+1)+t.substr(t.indexOf("-")+1),n.pptpvpnIpStart=a.utils.format.ip(n.pptpvpnIpStart),n.pptpvpnIpEnd=a.utils.format.ip(n.pptpvpnIpEnd)}}),s.device.getConfig().supportL2tpIpsec&&r.l2tpIpsecModel.load({success:function(e){var t=r.l2tpIpsecModel.getData().remoteip;n.l2tpvpnIpStart=t.substr(0,t.indexOf("-")),n.l2tpvpnIpEnd=n.l2tpvpnIpStart.substr(0,n.l2tpvpnIpStart.lastIndexOf(".")+1)+t.substr(t.indexOf("-")+1),n.l2tpvpnIpStart=a.utils.format.ip(n.l2tpvpnIpStart),n.l2tpvpnIpEnd=a.utils.format.ip(n.l2tpvpnIpEnd)}}),r.dhcpServer.load({success:function(e){var t=r.dhcpServer.getData();n.dhcpIpStart=t.ipaddrStart,n.dhcpIpEnd=t.ipaddrEnd}}),p.dhcpAddressList.load({success:function(e){n.dhcpReservation=e}}),r.lanAdvWanModel.load({success:function(e){var t=r.lanAdvWanModel.getData();n.lanIpv4Ipaddr=t.lanIpv4Ipaddr,n.wanIpv4Ipaddr=t.wanIpv4Ipaddr,n.wanIpv4Pridns=t.wanIpv4Pridns||"",r.lanAdvWanModel.wanIpv4Ipaddr.disable(),r.lanAdvWanModel.wanIpv4Pridns.disable(),n.wanIpv4Ipaddr||r.lanAdvWanModel.wanIpv4Ipaddr.setError(d.su.CHAR.VPN_SERVER_OPENVPN.NO_INTERNET_TIPS)}})},ev_before_destroy:function(){this.beforeDestroy()}},init:function(n,r,e,t,p,a){this.configViews({id:"openVpnView",items:[]}),this.listen({"models.openVpnModel":{ev_loaded:function(e,t){n.certExist=t.certExist||!1,t.certExist||n.certGenerateResult?r.openVpnView.certTips.hide():r.openVpnView.certTips.show()}},"models.openVpnModel.enable":{ev_value_change:function(e,t){"on"===t?r.openVpnView.openVpnFieldset.show():r.openVpnView.openVpnFieldset.hide()}}}),this.control({"#submit-generate":{ev_button_click:function(e,t){r.openVpnView.generateCertStatus.hide(),n.operateMode="",n.generateCert()}},"#generate-cert-msg":{ev_msg_cancel:function(){n.operateMode=""},ev_msg_ok:function(){n.generateCert()}},"#submit-export":{ev_button_click:function(){n.wanIpv4Ipaddr?(n.operateMode="exportConfig",n.exportConfiguration()):r.openVpnView.noInternetMsg.show()}},"#msg-generate-cert-progress":{ev_msg_close:function(){this.cancelGenerateCert()}},".index-common-save-btn":{ev_will_auto_save:function(e,t){n.operateMode="submitModel",n.checkFormSettings()||t.preventDefault()}}})}},function(a,s,o,e,i,c){var a=this,t=!1;return{checkFormSettings:function(){var e=o.openVpnModel,t=s.openVpnView,n=e.subnet.getValue(),r=e.mask.getValue();if(i.utils.isSameNet(a.lanIpv4Ipaddr,n,r))return e.subnet.setError(d.su.CHAR.VPN_SERVER_OPENVPN.SAME_SUBNET_NOTE),!1;if(i.utils.ipToInt(r)>i.utils.ipToInt("255.255.255.248"))return e.mask.setError(d.su.CHAR.VPN_SERVER_OPENVPN.VPN_MASK_ERROR),!1;if(i.utils.isSameNet(a.pptpvpnIpStart,n,"255.255.255.0"))return e.subnet.setError(d.su.CHAR.VPN_SERVER_OPENVPN.CONFLICT_WITH_PPTPVPN),!1;if(c.device.getConfig().supportL2tpIpsec&&i.utils.isSameNet(a.l2tpvpnIpStart,n,"255.255.255.0"))return e.subnet.setError(d.su.CHAR.VPN_SERVER_OPENVPN.CONFLICT_WITH_L2TPVPN),!1;for(var p=0;p<a.dhcpReservation.length;++p)if(i.utils.isSameNet(a.dhcpReservation[p].ip,n,r))return e.subnet.setError(d.su.CHAR.VPN_SERVER_OPENVPN.CONFLICT_WITH_RESERVED2),!1;return i.utils.isSameNet(a.dhcpIpStart,n,"255.255.255.0")?(e.subnet.setError(d.su.CHAR.VPN_SERVER_OPENVPN.CONFLICT_WITH_DHCP2),!1):a.wanIpv4Ipaddr?!(!a.certExist&&!a.certGenerateResult&&(t.confirmGenerate.show(),1)):(t.noInternetMsg.show(),!1)},generateCert:function(){var e=s.openVpnView;e.confirmGenerate.hide(),e.progressbarWrap.show(),e.certProgressbar.reset(),e.certProgressbar.animate({percentageStart:0,percentageEnd:100,duration:48e4,callback:function(){a.generateCertCallBack("timeout")}}),c.ajax.request({proxy:"openVpnGenerateCertificateProxy",success:function(e){t=setInterval(a.checkGenerateStatus,1e3)}})},cancelGenerateCert:function(){s.openVpnView.certProgressbar.reset(),a.generateCertCallBack("exit")},exportConfiguration:function(){a.certExist||a.certGenerateResult?c.ajax.upload({proxy:"openVpnExportProxy",fileId:"export-config-file"}):s.openVpnView.confirmGenerate.show()},checkGenerateStatus:function(){c.ajax.request({proxy:"openVpnCheckCertificateProxy",success:function(e){switch(e.certStatus){case"generating":break;case"error":a.generateCertCallBack("error");break;case"success":a.generateCertCallBack("success")}}})},generateCertCallBack:function(e){t&&(clearInterval(t),t=!1),"success"===e?(s.openVpnView.certTips.hide(),s.openVpnView.certProgressbar.setValue(100,1200),setTimeout(function(){a.certGenerateResult=!0,s.openVpnView.progressbarWrap.hide(),"submitModel"==a.operateMode?o.openVpnModel.validate()&&a.checkFormSettings()&&o.openVpnModel.submit():"exportConfig"==a.operateMode?a.exportConfiguration():(s.openVpnView.generateCertStatus.show(),s.openVpnView.generateCertStatus.setSuccess(d.su.CHAR.VPN_SERVER_OPENVPN.CERT_SUCCESS))},1200)):(clearInterval(t),t=!1,a.certGenerateResult=!1,s.openVpnView.progressbarWrap.hide(),"exit"===e?s.openVpnView.generateCertStatus.hide():(s.openVpnView.generateCertStatus.show(),s.openVpnView.generateCertStatus.setFailed(d.su.CHAR.VPN_SERVER_OPENVPN.CERT_FAIL)))},beforeDestroy:function(){t&&(clearInterval(t),t=!1)}}})}(jQuery);